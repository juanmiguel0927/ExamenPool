<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiro Maestro - Billiard University</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { slate: { 850: '#1e293b' } } } }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.98); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-in-fade { animation: fadeIn 0.2s ease-out; }
        .animate-in-zoom { animation: zoomIn 0.2s ease-out; }

        /* Animación del Paño */
        @keyframes clothColorCycle {
            0% { fill: #15803d; } /* Green */
            25% { fill: #1e40af; } /* Blue */
            50% { fill: #b91c1c; } /* Red */
            75% { fill: #7e22ce; } /* Purple */
            100% { fill: #15803d; }
        }
        .animate-felt {
            animation: clothColorCycle 20s infinite alternate ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. ICONOS ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Target = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>;
        const Trophy = (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const Shield = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>;
        const BookOpen = (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const ChevronLeft = (p) => <IconBase {...p}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRight = (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>;
        const Globe = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></IconBase>;
        const Info = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const ExternalLink = (p) => <IconBase {...p}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></IconBase>;
        const AlertCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></IconBase>;
        const Minus = (p) => <IconBase {...p}><line x1="5" x2="19" y1="12" y2="12"/></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const LogOut = (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>;
        const Hash = (p) => <IconBase {...p}><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const GraduationCap = (p) => <IconBase {...p}><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></IconBase>;
        const Check = (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const FileText = (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const Clock = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const TrendingUp = (p) => <IconBase {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>;
        const Moon = (p) => <IconBase {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconBase>;
        const Sun = (p) => <IconBase {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>;

        // ------------------------------------------------------------------
        // 2. CONFIGURACIÓN Y DATOS
        // ------------------------------------------------------------------
        const PDF_RAW_URL = "https://cdn.jsdelivr.net/gh/juanmiguel0927/ExamenPool@5eae9e124ba5a7b3353ea766ce4533d87b00b94a/All.pdf";
        const getPdfViewerUrl = (page) => `${PDF_RAW_URL}#page=${page}&view=FitH&toolbar=0&navpanes=0`;

        const LEVELS = [
            { name_es: "Novato", min: 0, color: "text-gray-500 dark:text-gray-400", bg: "bg-gray-100 dark:bg-gray-800" },
            { name_es: "Principiante", min: 50, color: "text-green-500 dark:text-green-400", bg: "bg-green-100 dark:bg-green-900/30" },
            { name_es: "Aficionado", min: 100, color: "text-blue-500 dark:text-blue-400", bg: "bg-blue-100 dark:bg-blue-900/30" },
            { name_es: "Intermedio", min: 150, color: "text-indigo-500 dark:text-indigo-400", bg: "bg-indigo-100 dark:bg-indigo-900/30" },
            { name_es: "Avanzado", min: 200, color: "text-purple-500 dark:text-purple-400", bg: "bg-purple-100 dark:bg-purple-900/30" },
            { name_es: "Semiprofesional", min: 250, color: "text-orange-500 dark:text-orange-400", bg: "bg-orange-100 dark:bg-orange-900/30" },
            { name_es: "Maestro", min: 300, color: "text-red-600 dark:text-red-400", bg: "bg-red-100 dark:bg-red-900/30" },
            { name_es: "Leyenda", min: 350, color: "text-yellow-600 dark:text-yellow-400", bg: "bg-yellow-100 dark:bg-yellow-900/30" }
        ];

        const BU_RATING_LEVELS = [
            { score: 0, label: "Recreativo" },
            { score: 55, label: "Principiante (D- a D+)" },
            { score: 85, label: "Intermedio (C- a C+)" },
            { score: 110, label: "Avanzado (B- a B+)" },
            { score: 140, label: "Experto (A- a A)" },
            { score: 165, label: "Semiprofesional (A+ a AA)" },
            { score: 185, label: "Profesional (AAA)" }
        ];

        const BADGES = [
            { id: 'first_steps', name: 'Primeros Pasos', desc: 'Completar tu primer ejercicio', icon: Target, condition: (s) => Object.keys(s).length > 0 },
            { id: 'dedicated', name: 'Dedicado', desc: 'Más de 50 ejercicios completados', icon: Clock, condition: (s) => {
                let count = 0; Object.values(s).forEach(e => count += Object.keys(e).length); return count > 50;
            }},
            { id: 'sharpshooter', name: 'Francotirador', desc: 'Puntuación perfecta en un ejercicio', icon: CheckCircle, condition: (s) => {
                return Object.values(s).some(exam => Object.values(exam).some(val => val >= 10));
            }},
            { id: 'master_class', name: 'Clase Maestra', desc: 'Alcanzar nivel Maestro', icon: GraduationCap, condition: (s) => {
                 let sum = 0; Object.values(s).forEach(e => Object.values(e).forEach(v => sum += Number(v))); return sum >= 300;
            }}
        ];

        const glossaryTerms = [
            { term: "CB", def_es: "Bola Blanca (Cue Ball)." },
            { term: "OB", def_es: "Bola Objetivo (Object Ball)." },
            { term: "BIH", def_es: "Bola en Mano." },
            { term: "Cut Shot", def_es: "Tiro de Corte / Fina." },
            { term: "Stop Shot", def_es: "Tiro de Stop / Clavada." },
            { term: "Follow Shot", def_es: "Tiro Corrido (Efecto arriba)." },
            { term: "Draw Shot", def_es: "Tiro de Retroceso (Efecto abajo)." },
            { term: "Stun Shot", def_es: "Tiro Seco." },
            { term: "Ghost Ball", def_es: "Bola Fantasma (Referencia)." },
            { term: "Rail", def_es: "Banda." },
            { term: "Scratch", def_es: "Falta (Mingo)." }
        ];

        // --- 3. GENERADORES DE DATOS ---
        const generateExam3Drills = () => {
            const drills = [];
            drills.push({ id: "A1", name: "Tiro A1", desc: "Práctica de tiro avanzado.", pdf_page: 51, max_score: 4, total_shots: 3, scoringType: 'weighted', subDrills: [{ id: "A1", name: "Tiro A1", max_score: 4, total_shots: 3, scoringType: 'weighted' }] });
            for (let i = 2; i <= 25; i += 2) {
                const page = 52 + (i - 2) / 2;
                const id1 = `A${i}`;
                const id2 = `A${i+1}`;
                drills.push({ id: `${id1}-${id2}`, name: `Tiros ${id1} y ${id2}`, desc: "Práctica de tiros avanzados (Pares).", pdf_page: page, isGroup: true, subDrills: [ { id: id1, name: `Tiro ${id1}`, max_score: 4, total_shots: 3, scoringType: 'weighted' }, { id: id2, name: `Tiro ${id2}`, max_score: 4, total_shots: 3, scoringType: 'weighted' } ] });
            }
            return drills;
        };

        const generatePPCData = () => {
            const drills = [];
            drills.push({
                id: "PPC-1", name: "Ejercicio 1", desc: "Layout 1 de PPC.", pdf_page: 68, max_score: 100, total_shots: 100, scoringType: 'deduction',
                subDrills: [{ id: "PPC-1", name: "Layout 1", max_score: 100, total_shots: 1, scoringType: 'deduction' }]
            });
            for (let i = 2; i <= 17; i += 2) {
                const page = 68 + (i / 2); 
                const id1 = `PPC-${i}`;
                const id2 = `PPC-${i+1}`;
                drills.push({
                    id: `${id1}-${id2}`, name: `Ejercicios ${i} y ${i+1}`, desc: "Layouts PPC.", pdf_page: page, isGroup: true,
                    subDrills: [
                        { id: id1, name: `Layout ${i}`, max_score: 100, total_shots: 1, scoringType: 'deduction' },
                        { id: id2, name: `Layout ${i+1}`, max_score: 100, total_shots: 1, scoringType: 'deduction' }
                    ]
                });
            }
            drills.push({
                id: "PPC-18", name: "Ejercicio 18", desc: "Layout 18 de PPC.", pdf_page: 77, max_score: 100, total_shots: 1, scoringType: 'deduction',
                subDrills: [{ id: "PPC-18", name: "Layout 18", max_score: 100, total_shots: 1, scoringType: 'deduction' }]
            });
            return drills;
        };

        const generateExam6Drills = () => {
            const drills = [];
            for (let i = 1; i <= 20; i += 2) {
                const page = 78 + Math.floor((i - 1) / 2);
                const id1 = `Safe${i}`;
                const id2 = `Safe${i+1}`;
                drills.push({ id: `${id1}-${id2}`, name: `Defensas ${i} y ${i+1}`, desc: "Ejercicios de Seguridad (Pares).", pdf_page: page, isGroup: true, subDrills: [ { id: id1, name: `Defensa ${i}`, max_score: 1, total_shots: 1, scoringType: 'count' }, { id: id2, name: `Defensa ${i+1}`, max_score: 1, total_shots: 1, scoringType: 'count' } ] });
            }
            return drills;
        };

        const examsData = {
            I: { id: "I", title: "Examen I - Fundamentos", desc: "Ejercicios progresivos.", drills: [ { id: "F1", name: "Tiro de Corte", desc: "Práctica progresiva. 10 tiros total.", max_score: 10, total_shots: 10, pdf_page: 1, scoringType: 'progressive' }, { id: "F2", name: "Tiro de Stop", desc: "Detener CB en zona fantasma.", max_score: 10, total_shots: 10, pdf_page: 2, scoringType: 'progressive' }, { id: "F3", name: "Tiro Corrido", desc: "Seguir a zona objetivo.", max_score: 10, total_shots: 10, pdf_page: 3, scoringType: 'progressive' }, { id: "F4", name: "Tiro de Retroceso", desc: "Retroceder a zona objetivo.", max_score: 10, total_shots: 10, pdf_page: 4, scoringType: 'progressive' }, { id: "F5", name: "Tiro Seco", desc: "Control de stun.", max_score: 10, total_shots: 10, pdf_page: 5, scoringType: 'progressive' }, { id: "F6", name: "Embocar Bolas", desc: "Sin tocar bandas innecesarias.", max_score: 10, total_shots: 10, pdf_page: 6, scoringType: 'count' }, { id: "F7", name: "Rueda de Carreta", desc: "Control de dirección.", max_score: 20, total_shots: 20, pdf_page: 7, scoringType: 'count' }, { id: "F8", name: "Objetivo en Rejilla", desc: "Posición precisa.", max_score: 20, total_shots: 20, pdf_page: 8, scoringType: 'count' } ] },
            II: { id: "II", title: "Examen II - Habilidades", desc: "Situaciones reales por nivel.", levels: ["Bachelors", "Masters", "Doctorate"], drills: [ { id: "S1", name: "Línea de Bolas", max_score: {Bachelors: 4, Masters: 7, Doctorate: 10}, total_shots: 2, scoringType: 'count', pdf_page: {Bachelors: 9, Masters: 23, Doctorate: 37} }, { id: "S2", name: "Corte de Banda", max_score: {Bachelors: 6, Masters: 10, Doctorate: 14}, total_shots: 2, scoringType: 'count', pdf_page: {Bachelors: 10, Masters: 24, Doctorate: 38} }, { id: "S3", name: "Patrones Bola 9", max_score: 10, total_shots: 3, scoringType: 'count', has_variations: true, variations: [ { id: "S3-L1", name: "Layout 1", pdf_page: { Bachelors: 11, Masters: 25, Doctorate: 39 }, max_score: 10, total_shots: 1, scoringType: 'count' }, { id: "S3-L2", name: "Layout 2", pdf_page: { Bachelors: 12, Masters: 26, Doctorate: 40 }, max_score: 10, total_shots: 1, scoringType: 'count' }, { id: "S3-L3", name: "Layout 3", pdf_page: { Bachelors: 13, Masters: 27, Doctorate: 41 }, max_score: 10, total_shots: 1, scoringType: 'count' } ] }, { id: "S4", name: "Patrones Bola 8", max_score: 10, total_shots: 3, scoringType: 'count', has_variations: true, variations: [ { id: "S4-L1", name: "Layout 1", pdf_page: { Bachelors: 14, Masters: 28, Doctorate: 42 }, max_score: 10, total_shots: 1, scoringType: 'count' }, { id: "S4-L2", name: "Layout 2", pdf_page: { Bachelors: 15, Masters: 29, Doctorate: 43 }, max_score: 10, total_shots: 1, scoringType: 'count' }, { id: "S4-L3", name: "Layout 3", pdf_page: { Bachelors: 16, Masters: 30, Doctorate: 44 }, max_score: 10, total_shots: 1, scoringType: 'count' } ] }, { id: "S5", name: "Defensas", max_score: {Bachelors: 6, Masters: 10, Doctorate: 14}, total_shots: {Bachelors: 6, Masters: 10, Doctorate: 14}, scoringType: 'count', pdf_page: {Bachelors: 17, Masters: 31, Doctorate: 45} }, { id: "S6", name: "Tiro de Retruque", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', pdf_page: {Bachelors: 18, Masters: 32, Doctorate: 46} }, { id: "S7", name: "Tiro de Banda", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', pdf_page: {Bachelors: 19, Masters: 33, Doctorate: 47} }, { id: "S8", name: "Tiro Elevado", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', pdf_page: {Bachelors: 20, Masters: 34, Doctorate: 48} }, { id: "S9", name: "Salto o Massé", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', pdf_page: {Bachelors: 21, Masters: 35, Doctorate: 49} }, { id: "S10", name: "Saque", max_score: 5, total_shots: 3, scoringType: 'count', pdf_page: {Bachelors: 22, Masters: 36, Doctorate: 50} } ] },
            III: { id: "III", title: "Examen III - Tiros Avanzados", desc: "25 tiros específicos.", drills: generateExam3Drills() },
            IV: { id: "IV", title: "RDS - Sistema de Limpieza", desc: "16 Niveles.", drills: Array.from({length: 16}, (_, i) => { let page = 65; if (i >= 6 && i <= 11) page = 66; if (i >= 12) page = 67; return { id: `L${i+1}`, name: `Nivel ${i+1}`, max_score: 100, total_shots: 1, scoringType: 'count', pdf_page: page }; }) },
            V: { id: "V", title: "PPC - Desafío de Colocación", desc: "18 Layouts (1-18).", drills: generatePPCData() },
            VI: { id: "VI", title: "Desafío de Seguridad", desc: "20 Tiros defensivos.", drills: generateExam6Drills() }
        };

        // --- 4. COMPONENTES AUXILIARES ---
        const SessionTimer = () => {
            const [seconds, setSeconds] = useState(0);
            useEffect(() => { const interval = setInterval(() => setSeconds(s => s + 1), 1000); return () => clearInterval(interval); }, []);
            const format = (s) => { const m = Math.floor(s/60); const sc = s%60; return `${m}:${sc<10?'0':''}${sc}`; };
            return <div className="hidden md:flex items-center gap-2 bg-gray-800 px-3 py-1 rounded text-sm font-mono text-gray-300 ml-4"><Clock size={14} /> {format(seconds)}</div>;
        };

        const SimpleProgressChart = ({ data }) => {
            if (!data || data.length < 2) return <div className="text-center text-gray-400 dark:text-gray-500 text-sm py-8">Practica más días para ver tu progreso</div>;
            const width = 400; const height = 150; const padding = 20;
            const maxScore = Math.max(...data.map(d => d.score), 100);
            const points = data.map((d, i) => {
                const x = padding + (i / (data.length - 1)) * (width - 2 * padding);
                const y = height - padding - (d.score / maxScore) * (height - 2 * padding);
                return `${x},${y}`;
            }).join(' ');
            return (
                <div className="w-full overflow-hidden">
                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto">
                        <polyline fill="none" stroke="#22c55e" strokeWidth="3" points={points} />
                        {data.map((d, i) => {
                             const x = padding + (i / (data.length - 1)) * (width - 2 * padding);
                             const y = height - padding - (d.score / maxScore) * (height - 2 * padding);
                             return <circle key={i} cx={x} cy={y} r="4" fill="#fff" stroke="#22c55e" strokeWidth="2" />
                        })}
                    </svg>
                    <div className="flex justify-between text-xs text-gray-400 mt-2"><span>Inicio</span><span>Actual</span></div>
                </div>
            );
        };

        // --- 5. PANELES DE PUNTUACIÓN ---
        // Unified Action Buttons
        const ActionButtons = ({ onHit, onMiss, hitDisabled, missDisabled }) => (
            <div className="flex gap-6 w-full max-w-md mb-8">
                <button onClick={onMiss} disabled={missDisabled} className="flex-1 bg-red-500 hover:bg-red-600 disabled:bg-gray-200 dark:disabled:bg-gray-700 disabled:text-gray-400 disabled:cursor-not-allowed text-white font-black text-2xl py-8 rounded-2xl shadow-xl shadow-red-100 dark:shadow-none transform transition active:scale-95 flex flex-col items-center justify-center gap-2"><X size={32} strokeWidth={4} /><span className="text-xs uppercase font-bold opacity-80">Fallo</span></button>
                <button onClick={onHit} disabled={hitDisabled} className="flex-1 bg-green-500 hover:bg-green-600 disabled:bg-gray-200 dark:disabled:bg-gray-700 disabled:text-gray-400 disabled:cursor-not-allowed text-white font-black text-2xl py-8 rounded-2xl shadow-xl shadow-green-100 dark:shadow-none transform transition active:scale-95 flex flex-col items-center justify-center gap-2"><Check size={32} strokeWidth={4} /><span className="text-xs uppercase font-bold opacity-80">Acierto</span></button>
            </div>
        );

        const UnifiedScoringPanel = ({ drill, currentScore, onScoreChange, onClose, onNext, isLast, onReset, notes, onSaveNote, noteText, setNoteText, showNotes, setShowNotes, level }) => {
            const [attemptsMade, setAttemptsMade] = useState(0);
            
            // Reset state when drill changes
            useEffect(() => { 
                setAttemptsMade(0); 
            }, [drill.id]); 

            let totalShotsDisplay = 10;
            let maxScore = drill.max_score;
            if (typeof maxScore === 'object' && maxScore !== null) {
                maxScore = maxScore[level] || 10;
            }
            
            if (drill.total_shots) {
                 if (typeof drill.total_shots === 'object') totalShotsDisplay = drill.total_shots[level] || 10;
                 else totalShotsDisplay = drill.total_shots;
            }
            if (drill.scoringType === 'weighted') totalShotsDisplay = 3;
            if (drill.scoringType === 'deduction') totalShotsDisplay = 100; 

            // LÓGICA UNIFICADA
            const handleHit = () => {
                if (drill.scoringType === 'progressive') {
                    // Progressive: Acierto sube posición o bono.
                    let pos = 0, bonus = 0;
                    if (currentScore > 0) {
                         if (currentScore <= 7) { pos = currentScore; bonus = 0; }
                         else { pos = 7; bonus = currentScore - 7; }
                    }
                    // Logic:
                    if (pos < 7) pos++;
                    else if (bonus < 3) bonus++;
                    
                    onScoreChange(pos + bonus);
                    setAttemptsMade(p => p + 1);
                } 
                else if (drill.scoringType === 'weighted') {
                    // Weighted (Examen III): Acierto da puntos según el intento actual y termina el ejercicio.
                    let points = 0;
                    if (attemptsMade === 0) points = 4;
                    else if (attemptsMade === 1) points = 2;
                    else if (attemptsMade === 2) points = 1;
                    
                    onScoreChange(points);
                    setAttemptsMade(3); // Marca como terminado visualmente
                }
                else if (drill.scoringType === 'deduction') {
                    // Deduction (PPC): Acierto = Buen tiro (no resta).
                    setAttemptsMade(p => p + 1);
                }
                else {
                    // Count: Standard +1
                    onScoreChange(currentScore + 1);
                    setAttemptsMade(p => p + 1);
                }
            };

            const handleMiss = () => {
                if (drill.scoringType === 'progressive') {
                    // Progressive: Fallo baja valor.
                    let pos = 0, bonus = 0;
                    if (currentScore > 0) {
                         if (currentScore <= 7) { pos = currentScore; bonus = 0; }
                         else { pos = 7; bonus = currentScore - 7; }
                    }
                    if (bonus > 0) bonus--;
                    else if (pos > 1) pos--;
                    
                    onScoreChange(pos + bonus);
                    setAttemptsMade(p => p + 1);
                }
                else if (drill.scoringType === 'weighted') {
                    // Weighted: Fallo pasa al siguiente intento.
                    setAttemptsMade(p => p + 1);
                    if (attemptsMade >= 2) onScoreChange(0); 
                }
                else if (drill.scoringType === 'deduction') {
                    // Deduction: Fallo resta puntos (añade error).
                    onScoreChange(currentScore - 1);
                    setAttemptsMade(p => p + 1);
                }
                else {
                    // Count: Solo cuenta intento
                    setAttemptsMade(p => p + 1);
                }
            };

            // Texto de estado dinámico
            let statusText = "Aciertos / Intentos";
            let bigScoreDisplay = currentScore;
            let subText = "";
            
            if (drill.scoringType === 'progressive') {
                let pos = 0, bonus = 0;
                if (currentScore > 0) { if (currentScore <= 7) { pos = currentScore; } else { pos = 7; bonus = currentScore - 7; } }
                statusText = `Posición: ${pos}`;
                if (bonus > 0) statusText += ` (+${bonus} Bono)`;
                subText = `Tiro ${Math.min(attemptsMade + 1, 10)} de 10`;
            } else if (drill.scoringType === 'weighted') {
                statusText = "Puntos Obtenidos";
                if (attemptsMade < 3 && currentScore === 0) subText = `Intento ${attemptsMade + 1} de 3`;
                else subText = "Ejercicio Completado";
            } else if (drill.scoringType === 'deduction') {
                statusText = "Puntos Restantes";
            } else {
                statusText = "Aciertos";
            }

            let buttonsDisabled = false;
            if (drill.scoringType === 'progressive' && attemptsMade >= 10) buttonsDisabled = true;
            if (drill.scoringType === 'weighted' && (attemptsMade >= 3 || currentScore > 0)) buttonsDisabled = true;
            if (drill.scoringType === 'count' && attemptsMade >= totalShotsDisplay) buttonsDisabled = true;

            const handleLocalReset = () => {
                onReset();
                setAttemptsMade(0);
            };

            const handleSaveNote = () => { onSaveNote(noteText); setShowNotes(false); };

            return (
                <div className="flex flex-col h-full p-8 items-center justify-between relative">
                    <button onClick={handleLocalReset} className="absolute top-0 left-0 text-gray-400 hover:text-red-500 flex items-center gap-1 text-xs uppercase font-bold transition p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg"><RotateCcw size={16} /> Reiniciar</button>
                    
                    {/* Animated Pool Table Background */}
                    <div className="absolute inset-0 z-0 pointer-events-none flex items-center justify-center opacity-5 dark:opacity-10">
                         <svg viewBox="0 0 400 200" className="w-[120%] h-auto">
                            <rect x="0" y="0" width="400" height="200" rx="20" fill="currentColor" className="text-gray-300 dark:text-gray-700" />
                            <rect x="25" y="25" width="350" height="150" fill="currentColor" className="text-green-100 dark:text-green-900/40 transition-colors duration-1000 animate-felt" />
                         </svg>
                    </div>

                    <div className="text-center w-full mt-4 relative z-10">
                        <div className="inline-block px-3 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full text-xs font-bold mb-4 tracking-wide uppercase">{drill.id} - {drill.name}</div>
                        
                        <div className="text-6xl font-black text-gray-900 dark:text-white mb-2 tracking-tighter leading-none">
                            {bigScoreDisplay} 
                            {drill.scoringType !== 'deduction' && drill.scoringType !== 'weighted' && <span className="text-4xl text-gray-300 dark:text-gray-600 font-medium">/ {drill.scoringType === 'progressive' ? 10 : totalShotsDisplay}</span>}
                        </div>
                        <div className="text-sm font-bold text-gray-400 uppercase tracking-widest mb-6">{statusText}</div>
                        {subText && <div className="text-xs text-gray-500 font-medium mb-6">{subText}</div>}
                        
                         {/* Barra Progreso Visual (Solo para Count/Progressive) */}
                         {(drill.scoringType === 'count' || drill.scoringType === 'progressive') && (
                            <div className="w-full max-w-md mx-auto h-2 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden mb-6">
                                <div className="h-full bg-blue-500 transition-all duration-300" style={{width: `${(attemptsMade / totalShotsDisplay) * 100}%`}}></div>
                            </div>
                         )}
                    </div>

                    <div className="relative z-10 w-full flex justify-center">
                        <ActionButtons onHit={handleHit} onMiss={handleMiss} hitDisabled={buttonsDisabled} missDisabled={buttonsDisabled} />
                    </div>

                    <div className="mt-2 mb-4 border-t border-gray-100 dark:border-gray-700 pt-4 w-full relative z-10"><button onClick={() => setShowNotes(!showNotes)} className="flex items-center gap-2 text-sm font-bold text-gray-500 hover:text-blue-600 w-full justify-center"><FileText size={16}/> {noteText ? 'Editar Nota' : 'Añadir Nota'}</button>{showNotes && <div className="mt-2 bg-yellow-50 dark:bg-yellow-900/30 p-2 rounded-lg border border-yellow-100 dark:border-yellow-900"><textarea className="w-full bg-transparent text-sm text-gray-700 dark:text-gray-300 focus:outline-none resize-none" rows="3" placeholder="Nota..." value={noteText} onChange={(e) => setNoteText(e.target.value)}></textarea><button onClick={handleSaveNote} className="w-full bg-yellow-200 dark:bg-yellow-700 text-yellow-800 dark:text-yellow-100 text-xs font-bold py-1 rounded mt-1 hover:bg-yellow-300">Guardar Nota</button></div>}{!showNotes && noteText && <p className="text-xs text-gray-500 mt-2 italic text-center">"{noteText}"</p>}</div>

                    <div className="w-full flex gap-3 relative z-10">
                         <button onClick={onClose} className="flex-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 font-bold py-4 rounded-xl shadow-sm transition uppercase tracking-widest text-sm hover:bg-gray-50 dark:hover:bg-gray-700">Cancelar</button>
                         <button onClick={onNext} className="flex-[2] bg-gray-800 dark:bg-green-600 hover:bg-gray-900 dark:hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition uppercase tracking-widest text-sm flex items-center justify-center gap-2">{isLast ? "Guardar y Salir" : "Guardar y Siguiente"} {!isLast && <ChevronRight size={18} />}</button>
                    </div>
                </div>
            );
        }

        const MiniScoringPanel = ({ drill, examId, updateScore, allExamScores }) => {
            const currentScore = allExamScores[drill.id] || 0;
            const [localAttempts, setLocalAttempts] = useState(0);
            
            const handleHit = () => {
                 if (drill.scoringType === 'deduction') {
                     setLocalAttempts(p => p + 1);
                 } else {
                     updateScore(examId, drill.id, currentScore + 1);
                     setLocalAttempts(p => p + 1);
                 }
            };
            const handleMiss = () => {
                if (drill.scoringType === 'deduction') {
                    updateScore(examId, drill.id, currentScore - 1);
                }
                setLocalAttempts(p => p + 1);
            };
            const handleReset = () => { updateScore(examId, drill.id, 0); setLocalAttempts(0); };

            return (
                <div className="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm relative mb-4">
                    <div className="flex justify-between items-center mb-3"><div><h4 className="font-bold text-gray-800 dark:text-gray-200">{drill.name}</h4></div><div className="text-xl font-black">{currentScore}</div></div>
                    <div className="flex gap-2">
                        <button onClick={handleMiss} className="flex-1 bg-red-500 text-white py-3 rounded-lg font-bold text-xs shadow">Fallo</button>
                        <button onClick={handleHit} className="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold text-xs shadow">Acierto</button>
                    </div>
                </div>
            );
        }

        const PracticeModalFinal = ({ drill, score, onScoreChange, onClose, onNextDrill, isLastDrill, level, examId, updateScore, allExamScores, notes, saveNote }) => {
            let pdfPage = drill.pdf_page;
            if (typeof pdfPage === 'object' && pdfPage !== null) { pdfPage = pdfPage[level] || pdfPage['Bachelors']; }
            const isMultiDrill = drill.isGroup && drill.subDrills;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-in-fade">
                    <div className="bg-white dark:bg-gray-900 w-full max-w-7xl h-[90vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row relative animate-in-zoom border border-gray-200 dark:border-gray-800">
                        <button onClick={onClose} className="absolute top-4 right-4 z-50 bg-white hover:bg-gray-100 text-gray-800 p-2 rounded-full shadow-md transition md:hidden"><X size={24} /></button>
                        <div className="w-full md:w-7/12 bg-gray-100 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 relative flex flex-col">
                             <iframe key={drill.id} src={getPdfViewerUrl(pdfPage)} className="w-full h-full border-none bg-gray-50" title="Diagrama"></iframe>
                        </div>
                        <div className="w-full md:w-5/12 bg-white dark:bg-gray-900 flex flex-col relative z-20 overflow-y-auto">
                            <div className="absolute top-4 right-4 hidden md:block"><button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><X size={24} /></button></div>
                            {isMultiDrill ? (
                                <div className="p-8 flex flex-col h-full">
                                    <div className="mb-6 text-center"><h2 className="text-2xl font-black text-gray-900 dark:text-white mb-1">{drill.name}</h2><p className="text-sm text-gray-500">{drill.desc}</p></div>
                                    <div className="flex-grow overflow-y-auto space-y-4 pr-2 mb-4">
                                        {drill.subDrills.map(subDrill => (
                                            <MiniScoringPanel key={subDrill.id} drill={subDrill} examId={examId} updateScore={updateScore} allExamScores={allExamScores} />
                                        ))}
                                    </div>
                                    <button onClick={onNextDrill} className="w-full mt-auto bg-gray-800 dark:bg-green-600 hover:bg-gray-900 dark:hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg uppercase text-sm flex justify-center gap-2">{isLastDrill ? "Guardar y Salir" : "Siguiente Página"} {!isLastDrill && <ChevronRight size={18} />}</button>
                                </div>
                            ) : (
                                <UnifiedScoringPanel key={drill.id} drill={drill} score={score} onScoreChange={onScoreChange} onReset={() => onScoreChange(0)} onNext={onNextDrill} isLast={isLastDrill} level={level} onClose={onClose} note={notes[`${examId}-${drill.id}`]} onSaveNote={(txt) => saveNote(examId, drill.id, txt)} />
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        
        const VariationsModal = ({ drill, onClose, onSelectVariation }) => (
             <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-in-fade">
                <div className="bg-white dark:bg-gray-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col p-6 relative animate-in-zoom">
                     <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-800 dark:hover:text-white"><X size={24} /></button>
                     <h3 className="text-xl font-black text-gray-900 dark:text-white mb-4 text-center">{drill.name}</h3>
                     <p className="text-gray-500 text-center mb-6 text-sm">{drill.desc_es}</p>
                     <div className="flex flex-col gap-3">
                         {drill.variations.map(v => (
                             <button key={v.id} onClick={() => onSelectVariation(v)} className="p-4 bg-gray-50 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900 border border-gray-200 dark:border-gray-600 hover:border-blue-200 rounded-xl text-left transition group">
                                 <span className="font-bold text-gray-800 dark:text-gray-200 group-hover:text-blue-700 block">{v.name}</span>
                                 <span className="text-xs text-gray-400 uppercase font-bold tracking-wider">ID: {v.id}</span>
                             </button>
                         ))}
                     </div>
                </div>
             </div>
        );

        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState("");
            const [usersList, setUsersList] = useState(() => { const saved = localStorage.getItem('bu_users_list'); return saved ? JSON.parse(saved) : []; });
            const [isCreating, setIsCreating] = useState(usersList.length === 0);
            const handleCreate = (e) => { e.preventDefault(); if(!username.trim()) return; const name = username.trim(); if (!usersList.includes(name)) { const newList = [...usersList, name]; setUsersList(newList); localStorage.setItem('bu_users_list', JSON.stringify(newList)); } onLogin(name); };
            const handleDelete = (name) => { if(confirm(`¿Borrar a ${name}?`)) { const newList = usersList.filter(u => u !== name); setUsersList(newList); localStorage.setItem('bu_users_list', JSON.stringify(newList)); localStorage.removeItem(`bu_scores_${name}`); localStorage.removeItem(`bu_history_${name}`); if(usersList.length === 1) setIsCreating(true); } };
            if (isCreating) return (<div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-900 px-4 relative overflow-hidden"><div className="absolute inset-0 z-0 flex items-center justify-center opacity-5 pointer-events-none"><svg viewBox="0 0 400 200" className="w-[150vw] h-auto text-green-600 dark:text-green-800 animate-felt"><rect x="0" y="0" width="400" height="200" rx="20" fill="#5D4037" /><rect x="25" y="25" width="350" height="150" fill="currentColor" /></svg></div><div className="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 text-center relative z-10">{usersList.length > 0 && <button onClick={() => setIsCreating(false)} className="absolute top-4 left-4 text-gray-400 hover:text-gray-600"><ChevronLeft size={24} /></button>}<div className="bg-green-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-md"><User size={32} className="text-white" /></div><h1 className="text-2xl font-extrabold text-gray-800 dark:text-white mb-2">Nuevo Jugador</h1><p className="text-gray-500 mb-6">Crea tu perfil</p><form onSubmit={handleCreate}><input type="text" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="Nombre" className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg mb-4 dark:bg-gray-700 dark:text-white" autoFocus /><button type="submit" disabled={!username.trim()} className="w-full bg-green-600 text-white font-bold py-3 rounded-lg">Crear</button></form></div></div>);
            return (<div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-900 px-4 relative overflow-hidden"><div className="absolute inset-0 z-0 flex items-center justify-center opacity-5 pointer-events-none"><svg viewBox="0 0 400 200" className="w-[150vw] h-auto text-green-600 dark:text-green-800 animate-felt"><rect x="0" y="0" width="400" height="200" rx="20" fill="#5D4037" /><rect x="25" y="25" width="350" height="150" fill="currentColor" /></svg></div><div className="max-w-4xl w-full relative z-10"><div className="text-center mb-8"><h1 className="text-4xl font-black text-gray-900 dark:text-white mb-2">TIRO MAESTRO</h1><p className="text-gray-500">Selecciona perfil</p></div><div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8">{usersList.map(u => <div key={u} onClick={() => onLogin(u)} className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition flex justify-between items-center cursor-pointer group"><span className="font-bold text-gray-800 dark:text-gray-200">{u}</span><button onClick={(e) => {e.stopPropagation(); handleDelete(u);}} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Trash2 size={18}/></button></div>)}<button onClick={() => setIsCreating(true)} className="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border-2 border-dashed dark:border-gray-700 hover:bg-green-50 flex justify-center items-center text-gray-500 hover:text-green-600"><Plus size={24} /><span className="ml-2 font-bold">Nuevo</span></button></div></div></div>);
        };
        const ExamCard = ({ exam, onSelect }) => (
            <div onClick={() => onSelect(exam)} className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 hover:shadow-xl hover:border-green-500 hover:-translate-y-1 transition-all duration-300 cursor-pointer group relative overflow-hidden"><div className="absolute top-0 right-0 bg-gradient-to-br from-gray-50 to-gray-100 w-24 h-24 rounded-bl-full -mr-10 -mt-10 transition-colors group-hover:from-green-50 group-hover:to-green-100"></div><div className="flex items-center gap-4 mb-4 relative z-10"><div className="p-3 bg-gray-100 rounded-xl group-hover:bg-green-600 group-hover:text-white transition-colors duration-300 text-gray-700 shadow-sm">{exam.id === 'I' && <RotateCcw size={28} />}{exam.id === 'II' && <Shield size={28} />}{exam.id === 'III' && <Trophy size={28} />}{['IV', 'V', 'VI'].includes(exam.id) && <BookOpen size={28} />}</div><h2 className="text-xl font-bold text-gray-800 group-hover:text-green-700 transition-colors">{exam.title}</h2></div><p className="text-gray-500 text-sm mb-6 leading-relaxed relative z-10">{exam.desc}</p><div className="text-green-600 text-sm font-bold flex items-center gap-2 group-hover:translate-x-2 transition-transform">Iniciar Evaluación <ChevronLeft className="rotate-180 w-4 h-4" /></div></div>
        );
        const UserProfile = ({ user, scores, goBack, onExport, onImport, history }) => {
            const scoreI = Object.values(scores['I'] || {}).reduce((a, b) => a + Number(b), 0);
            const scoreII = Object.values(scores['II'] || {}).reduce((a, b) => a + Number(b), 0);
            const buTotal = scoreI + scoreII;
            const buLevel = BU_RATING_LEVELS.slice().reverse().find(l => buTotal >= l.score) || BU_RATING_LEVELS[0];
            const badges = BADGES.filter(b => b.condition(scores));
            const fileInputRef = React.useRef();
            return (<div className="max-w-4xl mx-auto p-4"><button onClick={goBack} className="flex items-center text-gray-500 hover:text-gray-800 dark:hover:text-white mb-6"><ChevronLeft size={20} /> Volver</button><div className="bg-white dark:bg-gray-800 rounded-2xl shadow-md border border-gray-200 dark:border-gray-700 mb-6 p-8 flex flex-col md:flex-row items-center gap-6"><div className="w-24 h-24 rounded-full bg-green-500 flex items-center justify-center text-4xl font-bold border-4 border-white dark:border-gray-700 shadow-lg text-white">{user.charAt(0).toUpperCase()}</div><div className="text-center md:text-left flex-1"><h2 className="text-3xl font-bold text-gray-900 dark:text-white">{user}</h2><p className="text-lg text-gray-500">Nivel: <span className="font-bold text-blue-600 dark:text-blue-400">{buLevel.label}</span></p></div><div className="flex gap-2"><button onClick={onExport} className="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 px-3 py-2 rounded text-sm font-bold hover:bg-gray-200 dark:hover:bg-gray-600 dark:text-white"><Download size={14}/> Exportar</button><button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 px-3 py-2 rounded text-sm font-bold hover:bg-gray-200 dark:hover:bg-gray-600 dark:text-white"><Upload size={14}/> Importar</button><input type="file" ref={fileInputRef} onChange={onImport} className="hidden" accept=".json" /></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><div className="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm"><h4 className="font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2"><Trophy className="text-yellow-500" size={18}/> Puntuaciones Actuales</h4><div className="space-y-3"><div className="flex justify-between text-sm border-b border-gray-100 dark:border-gray-700 pb-2 dark:text-gray-300"><span>Examen I</span><b>{scoreI}/100</b></div><div className="flex justify-between text-sm border-b border-gray-100 dark:border-gray-700 pb-2 dark:text-gray-300"><span>Examen II</span><b>{scoreII}/100</b></div><div className="flex justify-between text-sm pt-1 dark:text-white"><span className="font-bold">Total BU</span><span className="font-black text-green-600 dark:text-green-400 text-lg">{buTotal}</span></div></div></div><div className="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm"><h4 className="font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2"><TrendingUp className="text-blue-500" size={18}/> Progreso Histórico</h4><SimpleProgressChart data={history} /></div></div><div className="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm"><h4 className="font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2"><Target className="text-purple-500" size={18}/> Medallas y Logros</h4><div className="flex flex-wrap gap-4">{badges.length > 0 ? badges.map(b => (<div key={b.id} className="flex items-center gap-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 px-3 py-2 rounded-lg"><b.icon className="text-yellow-600 dark:text-yellow-400" size={20} /><div><p className="text-sm font-bold text-yellow-800 dark:text-yellow-200">{b.name}</p><p className="text-[10px] text-yellow-600 dark:text-yellow-400">{b.desc}</p></div></div>)) : <p className="text-sm text-gray-400 italic">Completa ejercicios para ganar medallas.</p>}</div></div></div>);
        };
        const Header = ({ goHome, onProfileClick, user, onLogout, resetData, ExtraContent, darkMode, toggleDarkMode }) => (
            <header className="bg-gray-900 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-40 border-b border-gray-800"><div className="flex items-center gap-3 cursor-pointer group" onClick={goHome}><div className="bg-gradient-to-br from-green-500 to-green-700 p-2 rounded-xl shadow-lg group-hover:scale-105 transition-transform duration-200"><Target className="text-white w-7 h-7" /></div><div className="hidden sm:block"><h1 className="text-2xl font-extrabold tracking-tight leading-none">TIRO MAESTRO</h1><p className="text-[10px] text-gray-400 uppercase tracking-widest">Billiard University App</p></div></div><div className="flex gap-3 items-center">{ExtraContent}<button onClick={toggleDarkMode} className="p-2 text-gray-400 hover:text-yellow-400 transition">{darkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>{user && <React.Fragment><button onClick={resetData} className="p-2 text-gray-400 hover:text-red-400"><Trash2 size={20}/></button><button onClick={onProfileClick} className="flex items-center gap-2 bg-gray-800 px-3 py-1.5 rounded-full border border-gray-700"><div className="w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-[10px] font-bold">{user.charAt(0).toUpperCase()}</div><span className="font-medium hidden sm:inline text-sm">{user}</span></button><button onClick={onLogout} className="p-2 text-gray-400 hover:text-red-400"><LogOut size={20}/></button></React.Fragment>}</div></header>
        );
        const Glossary = ({ goBack }) => {
            const [search, setSearch] = useState("");
            return (<div className="max-w-3xl mx-auto p-4"><button onClick={goBack} className="flex items-center text-gray-500 dark:text-gray-400 mb-6"><ChevronLeft size={20} /> Volver</button><h2 className="text-3xl font-bold mb-6 text-gray-900 dark:text-white flex items-center gap-3"><BookOpen className="text-blue-600"/> Glosario de Billar</h2><input type="text" placeholder="Buscar términos..." className="w-full p-4 border rounded-xl shadow-sm mb-6 dark:bg-gray-800 dark:border-gray-700 dark:text-white" value={search} onChange={(e) => setSearch(e.target.value)} /><div className="grid gap-4">{glossaryTerms.filter(t => t.term.toLowerCase().includes(search.toLowerCase()) || t.def_es.toLowerCase().includes(search.toLowerCase())).map((t, i) => <div key={i} className="bg-white dark:bg-gray-800 p-5 rounded-xl border dark:border-gray-700 shadow-sm"><h3 className="font-bold text-xl text-blue-900 dark:text-blue-400">{t.term}</h3><p className="text-gray-600 dark:text-gray-300 text-sm">{t.def_es}</p></div>)}</div></div>);
        };
        const ExamDetail = ({ exam, onBack, user, scores, updateScore, resetExamScore, notes, saveNote }) => {
            const [activeDrill, setActiveDrill] = useState(null);
            const [selectedVariationDrill, setSelectedVariationDrill] = useState(null);
            const [level, setLevel] = useState("Bachelors");
            const currentDrills = useMemo(() => (exam.id !== 'II' ? exam.drills : exam.drills), [exam, level]);
            const handleDrillClick = (drill) => { if (drill.has_variations) setSelectedVariationDrill(drill); else setActiveDrill(drill); };
            const handleResetExam = () => { if(confirm("¿Estás seguro de reiniciar este examen?")) resetExamScore(exam.id); };
            const handleNextDrill = () => { if (!activeDrill) return; const currentIndex = currentDrills.findIndex(d => d.id === activeDrill.id); if (currentIndex >= 0 && currentIndex < currentDrills.length - 1) { const nextDrill = currentDrills[currentIndex + 1]; if (nextDrill.has_variations) { setActiveDrill(null); setSelectedVariationDrill(nextDrill); } else setActiveDrill(nextDrill); } else setActiveDrill(null); };
            const isLastDrill = activeDrill ? currentDrills.findIndex(d => d.id === activeDrill.id) === currentDrills.length - 1 : false;
            return (
                <div className="max-w-6xl mx-auto p-6 pb-24">
                    <div className="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-4"><div className="flex items-center gap-4"><button onClick={onBack} className="p-2 bg-white border border-gray-200 rounded-lg text-gray-500 hover:bg-gray-50 shadow-sm"><ChevronLeft size={24} /></button><div><h2 className="text-3xl font-black text-gray-900">{exam.title}</h2><p className="text-gray-500">{exam.desc}</p></div></div><div className="flex items-center gap-3"><button onClick={handleResetExam} className="flex items-center gap-2 px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg font-bold text-sm transition border border-transparent hover:border-red-100"><RotateCcw size={16} /> Reiniciar Nivel</button>{exam.id === 'II' && <div className="flex bg-white p-1.5 rounded-xl border border-gray-200 shadow-sm">{['Bachelors', 'Masters', 'Doctorate'].map(l => <button key={l} onClick={() => setLevel(l)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${level === l ? 'bg-gray-900 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900'}`}>{l === 'Bachelors' ? 'Licenciatura' : l === 'Masters' ? 'Maestría' : 'Doctorado'}</button>)}</div>}</div></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {currentDrills.map((drill) => {
                            let currentScore = 0; let maxDisplay = 0;
                            if (drill.has_variations) { drill.variations.forEach(v => { currentScore += (scores[exam.id] ? (scores[exam.id][v.id] || 0) : 0); }); maxDisplay = drill.variations.length * 10; }
                            else if (drill.isGroup) { drill.subDrills.forEach(sd => { currentScore += (scores[exam.id] ? (scores[exam.id][sd.id] || 0) : 0); maxDisplay += sd.max_score; }); } 
                            else { currentScore = scores[exam.id] ? (scores[exam.id][drill.id] || 0) : 0; maxDisplay = (typeof drill.max_score === 'object' ? drill.max_score[level] : drill.max_score) || 10; }
                            return (
                                <div key={drill.id} onClick={() => handleDrillClick(drill)} className="bg-white border border-gray-200 rounded-xl p-5 cursor-pointer hover:shadow-lg hover:border-green-400 transition-all group relative overflow-hidden"><div className="flex justify-between items-start mb-4 relative z-10"><div className="bg-gray-100 text-gray-600 font-bold w-12 h-12 rounded-lg flex items-center justify-center group-hover:bg-green-100 group-hover:text-green-700 text-lg">{drill.id.split('-')[0]}</div>{currentScore > 0 && <CheckCircle className="text-green-500" size={24} />}{(drill.isGroup || drill.has_variations) && <span className="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded">Multi</span>}</div><h3 className="font-bold text-lg text-gray-800 mb-1 group-hover:text-green-700 transition-colors relative z-10">{drill.name}</h3><p className="text-sm text-gray-500 mb-4 line-clamp-2 relative z-10">{drill.desc}</p><div className="w-full bg-gray-100 rounded-full h-1.5 mt-2 overflow-hidden"><div className="bg-green-500 h-1.5 rounded-full transition-all duration-500" style={{ width: `${(currentScore / maxDisplay) * 100}%` }}></div></div></div>
                            );
                        })}
                    </div>
                    {selectedVariationDrill && <VariationsModal drill={selectedVariationDrill} onClose={() => setSelectedVariationDrill(null)} onSelectVariation={(v) => { setSelectedVariationDrill(null); setActiveDrill(v); }} />}
                    {activeDrill && <PracticeModalFinal drill={activeDrill} score={scores[exam.id] ? (scores[exam.id][activeDrill.id] || 0) : 0} onScoreChange={(val) => updateScore(exam.id, activeDrill.id, val)} onClose={() => setActiveDrill(null)} onNextDrill={handleNextDrill} isLastDrill={isLastDrill} level={level} examId={exam.id} updateScore={updateScore} allExamScores={scores[exam.id] || {}} notes={scores.notes || {}} saveNote={saveNote} />} 
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(localStorage.getItem('bu_current_user') || null);
            const [view, setView] = useState(user ? 'home' : 'login'); 
            const [selectedExam, setSelectedExam] = useState(null);
            const [allScores, setAllScores] = useState({});
            const [notes, setNotes] = useState({});
            const [history, setHistory] = useState([]);
            const [darkMode, setDarkMode] = useState(localStorage.getItem('bu_dark_mode') === 'true');

            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                localStorage.setItem('bu_dark_mode', darkMode);
            }, [darkMode]);

            useEffect(() => {
                if (user) {
                    const savedScores = localStorage.getItem(`bu_scores_${user}`);
                    const savedNotes = localStorage.getItem(`bu_notes_${user}`);
                    const savedHistory = localStorage.getItem(`bu_history_${user}`);
                    setAllScores(savedScores ? JSON.parse(savedScores) : {});
                    setNotes(savedNotes ? JSON.parse(savedNotes) : {});
                    setHistory(savedHistory ? JSON.parse(savedHistory) : []);
                    if(savedScores) {
                        const scoresObj = JSON.parse(savedScores);
                        const total = Object.values(scoresObj).reduce((acc, exam) => acc + Object.values(exam).reduce((a, b) => a + Number(b), 0), 0);
                        const today = new Date().toISOString().split('T')[0];
                        const hist = savedHistory ? JSON.parse(savedHistory) : [];
                        const newHist = hist.filter(h => h.date !== today);
                        newHist.push({ date: today, score: total });
                        if(newHist.length > 30) newHist.shift();
                        setHistory(newHist);
                        localStorage.setItem(`bu_history_${user}`, JSON.stringify(newHist));
                    }
                    setView('home');
                } else { setView('login'); }
            }, [user]);

            const handleLogin = (u) => { localStorage.setItem('bu_current_user', u); setUser(u); };
            const handleLogout = () => { localStorage.removeItem('bu_current_user'); setUser(null); setAllScores({}); setNotes({}); setView('login'); };
            const updateScore = (eId, dId, val) => { const newScores = { ...allScores, [eId]: { ...(allScores[eId] || {}), [dId]: val } }; setAllScores(newScores); localStorage.setItem(`bu_scores_${user}`, JSON.stringify(newScores)); };
            const saveNote = (eId, dId, text) => { const newNotes = { ...notes, [`${eId}-${dId}`]: text }; setNotes(newNotes); localStorage.setItem(`bu_notes_${user}`, JSON.stringify(newNotes)); };
            const handleExport = () => { const data = { user, scores: allScores, notes, history, date: new Date().toISOString() }; const blob = new Blob([JSON.stringify(data)], { type: "application/json" }); const href = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = href; link.download = `bu_data_${user}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const handleImport = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (confirm(`Importar datos de ${data.user}?`)) { setAllScores(data.scores || {}); setNotes(data.notes || {}); setHistory(data.history || []); localStorage.setItem(`bu_scores_${user}`, JSON.stringify(data.scores || {})); localStorage.setItem(`bu_notes_${user}`, JSON.stringify(data.notes || {})); localStorage.setItem(`bu_history_${user}`, JSON.stringify(data.history || [])); alert("Datos importados."); } } catch (err) { alert("Error."); } }; reader.readAsText(file); };
            const resetExamScore = (eId) => { const ns = { ...allScores }; delete ns[eId]; setAllScores(ns); localStorage.setItem(`bu_scores_${user}`, JSON.stringify(ns)); };
            const resetAllData = () => { if(confirm("¿Borrar todo?")) { setAllScores({}); setNotes({}); localStorage.removeItem(`bu_scores_${user}`); localStorage.removeItem(`bu_notes_${user}`); localStorage.removeItem(`bu_history_${user}`); } };
            
            if (!user) return <LoginScreen onLogin={handleLogin} />;
            return (
                <div className="min-h-screen flex flex-col bg-gray-100 dark:bg-gray-900 font-sans text-gray-900 dark:text-gray-100 transition-colors duration-300">
                    <Header goHome={() => {setSelectedExam(null); setView('home');}} onProfileClick={() => setView('profile')} user={user} onLogout={handleLogout} resetData={resetAllData} ExtraContent={<SessionTimer />} darkMode={darkMode} toggleDarkMode={() => setDarkMode(!darkMode)} />
                    <main className="flex-grow">{view === 'home' && <div className="max-w-5xl mx-auto p-6"><div className="text-center mb-12 mt-8"><h1 className="text-5xl font-black text-gray-900 dark:text-white mb-4 tracking-tight">TIRO MAESTRO</h1><p className="text-xl text-gray-500 dark:text-gray-400 max-w-2xl mx-auto font-light">Plan de Evaluación Profesional</p></div><div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-16">{Object.values(examsData).map(exam => <ExamCard key={exam.id} exam={exam} onSelect={(e) => { setSelectedExam(e); setView('exam'); }} />)}</div><div className="flex justify-center"><button onClick={() => setView('glossary')} className="flex items-center gap-3 text-gray-600 dark:text-gray-300 hover:text-blue-600 font-bold transition px-8 py-4 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md"><BookOpen size={24} className="text-blue-500" /> Acceder al Glosario</button></div></div>}{view === 'profile' && <UserProfile user={user} scores={allScores} goBack={() => setView('home')} onExport={handleExport} onImport={handleImport} history={history} />}{view === 'exam' && selectedExam && <ExamDetail exam={selectedExam} onBack={() => { setSelectedExam(null); setView('home'); }} user={user} scores={allScores} updateScore={updateScore} resetExamScore={resetExamScore} notes={notes} saveNote={saveNote} />}{view === 'glossary' && <Glossary goBack={() => setView('home')} />}</main>
                    <footer className="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-8 text-center"><div className="max-w-2xl mx-auto"><div className="flex justify-center items-center gap-2 mb-4 text-gray-400"><GraduationCap size={24} /></div><p className="text-sm text-gray-500 dark:text-gray-400 mb-2 font-medium">&copy; 2025 Tiro Maestro App</p><p className="text-xs text-gray-400 dark:text-gray-500 leading-relaxed">Basado en el currículo del <strong className="text-gray-600 dark:text-gray-300">Dr. Dave Alciatore</strong>.<br/>Desarrollado por <strong className="text-gray-600 dark:text-gray-300">Juan Miguel Rios Redondo</strong>.</p><a href="https://billiarduniversity.org/" target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 text-blue-600 dark:text-blue-400 hover:text-blue-800 font-bold mt-3 text-sm hover:underline">billiarduniversity.org <ExternalLink size={12} /></a></div></footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

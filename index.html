<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiro Maestro - Billiard University</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (Production) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-in-fade { animation: fadeIn 0.2s ease-out; }
        .animate-in-zoom { animation: zoomIn 0.2s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICONOS ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Target = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>;
        const Trophy = (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const Shield = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>;
        const BookOpen = (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const ChevronLeft = (p) => <IconBase {...p}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRight = (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>;
        const Globe = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></IconBase>;
        const Info = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const ExternalLink = (p) => <IconBase {...p}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></IconBase>;
        const AlertCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></IconBase>;
        const Minus = (p) => <IconBase {...p}><line x1="5" x2="19" y1="12" y2="12"/></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const LogOut = (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>;
        const Hash = (p) => <IconBase {...p}><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const GraduationCap = (p) => <IconBase {...p}><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></IconBase>;
        const Check = (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const List = (p) => <IconBase {...p}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconBase>;

        // --- CONFIG & DATOS ---
        const PDF_RAW_URL = "https://cdn.jsdelivr.net/gh/juanmiguel0927/ExamenPool@5eae9e124ba5a7b3353ea766ce4533d87b00b94a/All.pdf";
        const getPdfViewerUrl = (page) => `${PDF_RAW_URL}#page=${page}&view=FitH&toolbar=0&navpanes=0`;

        const LEVELS = [
            { name_es: "Novato", min: 0, color: "text-gray-500", bg: "bg-gray-100" },
            { name_es: "Principiante", min: 50, color: "text-green-500", bg: "bg-green-100" },
            { name_es: "Aficionado", min: 100, color: "text-blue-500", bg: "bg-blue-100" },
            { name_es: "Intermedio", min: 150, color: "text-indigo-500", bg: "bg-indigo-100" },
            { name_es: "Avanzado", min: 200, color: "text-purple-500", bg: "bg-purple-100" },
            { name_es: "Semiprofesional", min: 250, color: "text-orange-500", bg: "bg-orange-100" },
            { name_es: "Maestro", min: 300, color: "text-red-600", bg: "bg-red-100" },
            { name_es: "Leyenda", min: 350, color: "text-yellow-600", bg: "bg-yellow-100" }
        ];

        const glossaryTerms = [
            { term: "CB", def_es: "Bola Blanca (Cue Ball)." },
            { term: "OB", def_es: "Bola Objetivo (Object Ball)." },
            { term: "BIH", def_es: "Bola en Mano." },
            { term: "Cut Shot", def_es: "Tiro de Corte / Fina." },
            { term: "Stop Shot", def_es: "Tiro de Stop / Clavada." },
            { term: "Follow Shot", def_es: "Tiro Corrido (Efecto arriba)." },
            { term: "Draw Shot", def_es: "Tiro de Retroceso (Efecto abajo)." },
            { term: "Stun Shot", def_es: "Tiro Seco." },
            { term: "Ghost Ball", def_es: "Bola Fantasma (Referencia)." },
            { term: "Rail", def_es: "Banda." },
            { term: "Scratch", def_es: "Falta (Mingo)." }
        ];

        // GENERADOR EXAMEN III
        const generateExam3Drills = () => {
            const drills = [];
            drills.push({
                id: "A1", name: "Tiro A1", desc: "Práctica de tiro avanzado.", pdf_page: 51, max_score: 4, total_shots: 3, scoringType: 'count',
                subDrills: [{ id: "A1", name: "Tiro A1", max_score: 4, total_shots: 3, scoringType: 'count' }]
            });
            for (let i = 2; i <= 25; i += 2) {
                const page = 52 + (i - 2) / 2;
                const id1 = `A${i}`;
                const id2 = `A${i+1}`;
                drills.push({
                    id: `${id1}-${id2}`,
                    name: `Tiros ${id1} y ${id2}`,
                    desc: "Práctica de tiros avanzados (Pares).",
                    pdf_page: page,
                    isGroup: true,
                    subDrills: [
                        { id: id1, name: `Tiro ${id1}`, max_score: 4, total_shots: 3, scoringType: 'count' },
                        { id: id2, name: `Tiro ${id2}`, max_score: 4, total_shots: 3, scoringType: 'count' }
                    ]
                });
            }
            return drills;
        };

        const examsData = {
            I: {
                id: "I", title: "Examen I - Fundamentos", desc: "Ejercicios progresivos básicos.",
                drills: [
                    { id: "F1", name: "Tiro de Corte", desc: "10 tiros total.", max_score: 10, total_shots: 10, pdf_page: 1, scoringType: 'progressive' },
                    { id: "F2", name: "Tiro de Stop", desc: "10 tiros total.", max_score: 10, total_shots: 10, pdf_page: 2, scoringType: 'progressive' },
                    { id: "F3", name: "Tiro Corrido", desc: "10 tiros total.", max_score: 10, total_shots: 10, pdf_page: 3, scoringType: 'progressive' },
                    { id: "F4", name: "Tiro de Retroceso", desc: "10 tiros total.", max_score: 10, total_shots: 10, pdf_page: 4, scoringType: 'progressive' },
                    { id: "F5", name: "Tiro Seco", desc: "10 tiros total.", max_score: 10, total_shots: 10, pdf_page: 5, scoringType: 'progressive' },
                    { id: "F6", name: "Embocar Bolas", desc: "10 tiros total.", max_score: 10, total_shots: 10, pdf_page: 6, scoringType: 'count' },
                    { id: "F7", name: "Rueda de Carreta", desc: "20 tiros total.", max_score: 20, total_shots: 20, pdf_page: 7, scoringType: 'count' },
                    { id: "F8", name: "Objetivo en Rejilla", desc: "20 tiros total.", max_score: 20, total_shots: 20, pdf_page: 8, scoringType: 'count' }
                ]
            },
            II: {
                id: "II", title: "Examen II - Habilidades", desc: "Situaciones reales por nivel.", levels: ["Bachelors", "Masters", "Doctorate"],
                drills: [
                    { id: "S1", name: "Línea de Bolas", max_score: {Bachelors: 4, Masters: 7, Doctorate: 10}, total_shots: 2, scoringType: 'best_of', pdf_page: {Bachelors: 9, Masters: 23, Doctorate: 37} },
                    { id: "S2", name: "Corte de Banda", max_score: {Bachelors: 6, Masters: 10, Doctorate: 14}, total_shots: 2, scoringType: 'best_of', pdf_page: {Bachelors: 10, Masters: 24, Doctorate: 38} },
                    { id: "S3", name: "Patrones Bola 9", max_score: 10, total_shots: 3, scoringType: 'sum_lowest', has_variations: true, 
                      variations: [
                          { id: "S3-L1", name: "Layout 1", pdf_page: { Bachelors: 11, Masters: 25, Doctorate: 39 }, max_score: 10, total_shots: 1, scoringType: 'count' },
                          { id: "S3-L2", name: "Layout 2", pdf_page: { Bachelors: 12, Masters: 26, Doctorate: 40 }, max_score: 10, total_shots: 1, scoringType: 'count' },
                          { id: "S3-L3", name: "Layout 3", pdf_page: { Bachelors: 13, Masters: 27, Doctorate: 41 }, max_score: 10, total_shots: 1, scoringType: 'count' }
                      ]
                    },
                    { id: "S4", name: "Patrones Bola 8", max_score: 10, total_shots: 3, scoringType: 'sum_lowest', has_variations: true,
                      variations: [
                          { id: "S4-L1", name: "Layout 1", pdf_page: { Bachelors: 14, Masters: 28, Doctorate: 42 }, max_score: 10, total_shots: 1, scoringType: 'count' },
                          { id: "S4-L2", name: "Layout 2", pdf_page: { Bachelors: 15, Masters: 29, Doctorate: 43 }, max_score: 10, total_shots: 1, scoringType: 'count' },
                          { id: "S4-L3", name: "Layout 3", pdf_page: { Bachelors: 16, Masters: 30, Doctorate: 44 }, max_score: 10, total_shots: 1, scoringType: 'count' }
                      ]
                    },
                    { id: "S5", name: "Defensas", max_score: {Bachelors: 6, Masters: 10, Doctorate: 14}, total_shots: {Bachelors: 6, Masters: 10, Doctorate: 14}, scoringType: 'count', pdf_page: {Bachelors: 17, Masters: 31, Doctorate: 45} },
                    { id: "S6", name: "Tiro de Retruque", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', pdf_page: {Bachelors: 18, Masters: 32, Doctorate: 46} },
                    { id: "S7", name: "Tiro de Banda", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', pdf_page: {Bachelors: 19, Masters: 33, Doctorate: 47} },
                    { id: "S8", name: "Tiro Elevado", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', pdf_page: {Bachelors: 20, Masters: 34, Doctorate: 48} },
                    { id: "S9", name: "Salto o Massé", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', pdf_page: {Bachelors: 21, Masters: 35, Doctorate: 49} },
                    { id: "S10", name: "Saque", max_score: 5, total_shots: 3, scoringType: 'median', pdf_page: {Bachelors: 22, Masters: 36, Doctorate: 50} }
                ]
            },
            III: {
                id: "III", title: "Examen III - Tiros Avanzados", desc: "25 tiros específicos.",
                drills: generateExam3Drills()
            },
            IV: {
                id: "IV", title: "RDS", desc: "16 Niveles.",
                drills: Array.from({length: 16}, (_, i) => ({
                    id: `L${i+1}`, name: `Nivel ${i+1}`, max_score: 100, total_shots: 1, scoringType: 'pass_fail', pdf_page: 65 + Math.floor(i/4)
                }))
            },
            V: {
                id: "V", title: "PPC", desc: "18 Configuraciones.",
                drills: [{ id: "PPC", name: "Desafío Completo", max_score: 100, total_shots: 18, scoringType: 'deduction', pdf_page: 68 }]
            },
            VI: {
                id: "VI", title: "Desafío de Seguridad", desc: "20 Tiros.",
                drills: Array.from({length: 20}, (_, i) => ({
                    id: `Safe${i+1}`, name: `Defensa ${i+1}`, max_score: 1, total_shots: 1, scoringType: 'count', pdf_page: 78 + Math.floor(i/2)
                }))
            }
        };

        // --- PUNTUACIÓN (Paneles) ---
        const ScoringPanel = ({ drill, score, onScoreChange, lang, level, onClose, onReset, onNext, isLast }) => {
            const currentScore = Number(score) || 0;
            let totalShots = (typeof drill.total_shots === 'object' && drill.total_shots !== null) ? (drill.total_shots[level] || 10) : (drill.total_shots || 10);
            let maxScore = (typeof drill.max_score === 'object' && drill.max_score !== null) ? (drill.max_score[level] || 10) : (drill.max_score || 10);
            
            const [attemptsMade, setAttemptsMade] = useState(0);
            useEffect(() => { if (currentScore > 0 && attemptsMade === 0) { /* Sync if needed */ } }, []);

            // Progressive
            if (drill.scoringType === 'progressive') {
                const [pos, setPos] = useState(0);
                const [bonus, setBonus] = useState(0);
                useEffect(() => {
                    if (currentScore > 0) {
                        if (currentScore <= 7) { setPos(currentScore); setBonus(0); }
                        else { setPos(7); setBonus(currentScore - 7); }
                    } else { setPos(0); setBonus(0); }
                }, [currentScore]);
                const update = (newPos, newBonus) => {
                    let p = Math.max(0, Math.min(7, newPos));
                    let b = Math.max(0, newBonus);
                    if (p < 7) b = 0; 
                    if (p + b > 10) b = 10 - p;
                    setPos(p); setBonus(b); onScoreChange(p + b);
                };
                return (
                    <div className="flex flex-col h-full p-6 relative">
                        <button onClick={onReset} className="absolute top-0 right-0 text-gray-400 hover:text-red-500 p-2"><RotateCcw size={16} /></button>
                        <h3 className="text-xl font-black text-gray-800 uppercase text-center mb-6">{drill.name}</h3>
                        <div className="flex-grow flex flex-col gap-6 justify-center">
                             <div className="bg-blue-50 p-6 rounded-xl border border-blue-100 shadow-sm">
                                <div className="flex justify-between mb-4"><span className="font-bold text-blue-900">POSICIÓN (1-7)</span><span className="text-4xl font-black text-blue-600">{pos}</span></div>
                                <div className="flex gap-3"><button onClick={() => update(pos - 1, bonus)} className="flex-1 py-3 bg-white rounded-lg shadow text-blue-600 text-xl"><Minus /></button><button onClick={() => update(pos + 1, bonus)} className="flex-1 py-3 bg-white rounded-lg shadow text-blue-600 text-xl"><Plus /></button></div>
                            </div>
                            <div className={`bg-green-50 p-6 rounded-xl border border-green-100 shadow-sm transition-opacity ${pos < 7 ? 'opacity-50 pointer-events-none' : 'opacity-100'}`}>
                                <div className="flex justify-between mb-4"><span className="font-bold text-green-900">BONO (+3)</span><span className="text-4xl font-black text-green-600">{bonus}</span></div>
                                <div className="flex gap-3"><button onClick={() => update(pos, bonus - 1)} className="flex-1 py-3 bg-white rounded-lg shadow text-green-600 text-xl"><Minus /></button><button onClick={() => update(pos, bonus + 1)} className="flex-1 py-3 bg-white rounded-lg shadow text-green-600 text-xl" disabled={pos+bonus>=10}><Plus /></button></div>
                            </div>
                        </div>
                         <div className="mt-auto pt-6 flex gap-3">
                            <button onClick={onClose} className="flex-1 bg-white border border-gray-300 text-gray-600 font-bold py-4 rounded-xl shadow-sm uppercase text-sm">Cancelar</button>
                            <button onClick={onNext} className="flex-[2] bg-gray-800 hover:bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg uppercase text-sm flex justify-center gap-2">{isLast ? "Guardar y Salir" : "Siguiente"} {!isLast && <ChevronRight size={18} />}</button>
                        </div>
                    </div>
                );
            }

            // Standard Count
            const handleHit = () => { if (attemptsMade < totalShots) { onScoreChange(Math.min(maxScore, currentScore + 1)); setAttemptsMade(p => p + 1); } };
            const handleMiss = () => { if (attemptsMade < totalShots) setAttemptsMade(p => p + 1); };
            useEffect(() => { if (currentScore > 0 && attemptsMade === 0) setAttemptsMade(currentScore); }, []);
            const handleLocalReset = () => { onReset(); setAttemptsMade(0); }

            return (
                <div className="flex flex-col h-full p-8 items-center justify-between relative">
                    <button onClick={handleLocalReset} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 flex items-center gap-1 text-xs uppercase font-bold transition p-2 hover:bg-gray-100 rounded-lg"><RotateCcw size={16} /> Reiniciar</button>
                    <div className="text-center w-full mt-8">
                        <div className="inline-block px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-xs font-bold mb-6 tracking-wide uppercase">{drill.id}</div>
                        <div className="text-6xl font-black text-gray-900 mb-2 tracking-tighter leading-none">{currentScore} <span className="text-4xl text-gray-300 font-medium">/ {totalShots}</span></div>
                        <div className="text-sm font-bold text-gray-400 uppercase tracking-widest mb-12">Aciertos / Intentos</div>
                        <div className="w-full max-w-md mx-auto h-2 bg-gray-100 rounded-full overflow-hidden mb-2"><div className="h-full bg-blue-500 transition-all duration-300" style={{width: `${(attemptsMade / totalShots) * 100}%`}}></div></div>
                        <div className="text-xs text-gray-400 font-medium">Tiro {Math.min(attemptsMade + 1, totalShots)} de {totalShots}</div>
                    </div>
                    <div className="flex gap-6 w-full max-w-md mb-8">
                        <button onClick={handleMiss} disabled={attemptsMade >= totalShots} className="flex-1 bg-red-500 hover:bg-red-600 disabled:bg-gray-200 disabled:text-gray-400 text-white font-black text-2xl py-8 rounded-2xl shadow-xl transform transition active:scale-95 flex flex-col items-center justify-center gap-2"><X size={32} strokeWidth={4} /><span className="text-xs uppercase font-bold opacity-80">Fallo</span></button>
                        <button onClick={handleHit} disabled={attemptsMade >= totalShots} className="flex-1 bg-green-500 hover:bg-green-600 disabled:bg-gray-200 disabled:text-gray-400 text-white font-black text-2xl py-8 rounded-2xl shadow-xl transform transition active:scale-95 flex flex-col items-center justify-center gap-2"><Check size={32} strokeWidth={4} /><span className="text-xs uppercase font-bold opacity-80">Acierto</span></button>
                    </div>
                    <div className="w-full flex gap-3">
                         <button onClick={onClose} className="flex-1 bg-white border border-gray-300 text-gray-600 font-bold py-4 rounded-xl shadow-sm uppercase text-sm">Cancelar</button>
                         <button onClick={onNext} className="flex-[2] bg-gray-800 hover:bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg uppercase text-sm flex justify-center gap-2">{isLast ? "Guardar y Salir" : "Siguiente"} {!isLast && <ChevronRight size={18} />}</button>
                    </div>
                </div>
            );
        };

        // Mini Panel para Examen III
        const MiniScoringPanel = ({ drill, examId, updateScore, allExamScores }) => {
            const currentScore = allExamScores[drill.id] || 0;
            const totalShots = drill.total_shots || 10;
            const maxScore = drill.max_score || 10;
            const [attemptsMade, setAttemptsMade] = useState(0);
            useEffect(() => { if (currentScore > 0) setAttemptsMade(Math.max(currentScore, attemptsMade)); }, [currentScore]);

            const handleHit = () => { if (attemptsMade < totalShots) { updateScore(examId, drill.id, Math.min(maxScore, currentScore + 1)); setAttemptsMade(p => p + 1); } };
            const handleMiss = () => { if (attemptsMade < totalShots) setAttemptsMade(p => p + 1); };
            const handleReset = () => { updateScore(examId, drill.id, 0); setAttemptsMade(0); };

            return (
                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-sm">
                    <div className="flex justify-between items-center mb-3">
                        <div><h4 className="font-bold text-gray-800">{drill.name}</h4><span className="text-xs text-gray-400 font-bold uppercase">{currentScore} Aciertos / {attemptsMade} Intentos</span></div>
                        <button onClick={handleReset} className="text-gray-400 hover:text-red-500 p-1"><RotateCcw size={16}/></button>
                    </div>
                    <div className="flex gap-3 mb-2">
                        <button onClick={handleMiss} disabled={attemptsMade >= totalShots} className="flex-1 bg-red-100 text-red-600 border border-red-200 py-3 rounded-lg font-bold text-sm shadow-sm hover:bg-red-200 active:scale-95 disabled:opacity-50">Fallo</button>
                        <button onClick={handleHit} disabled={attemptsMade >= totalShots} className="flex-1 bg-green-100 text-green-600 border border-green-200 py-3 rounded-lg font-bold text-sm shadow-sm hover:bg-green-200 active:scale-95 disabled:opacity-50">Acierto</button>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden"><div className="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style={{width: `${(attemptsMade / totalShots) * 100}%`}}></div></div>
                </div>
            );
        };
        
        const PracticeModalFinal = ({ drill, score, onScoreChange, onClose, onNextDrill, isLastDrill, level, examId, updateScore, allExamScores }) => {
            let pdfPage = drill.pdf_page;
            if (typeof pdfPage === 'object' && pdfPage !== null) { pdfPage = pdfPage[level] || pdfPage['Bachelors']; }
            const isMultiDrill = drill.isGroup && drill.subDrills;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-in-fade">
                    <div className="bg-white w-full max-w-7xl h-[90vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row relative animate-in-zoom border border-gray-200">
                        <button onClick={onClose} className="absolute top-4 right-4 z-50 bg-white/80 hover:bg-white text-gray-800 p-2 rounded-full shadow-md transition md:hidden"><X size={24} /></button>
                        <div className="w-full md:w-7/12 bg-gray-100 border-r border-gray-200 relative flex flex-col">
                             <iframe src={getPdfViewerUrl(pdfPage)} className="w-full h-full border-none bg-gray-50" title="Diagrama"></iframe>
                        </div>
                        <div className="w-full md:w-5/12 bg-white flex flex-col relative z-20 overflow-y-auto">
                             <div className="absolute top-4 right-4 hidden md:block"><button onClick={onClose} className="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition"><X size={24} /></button></div>
                            {isMultiDrill ? (
                                <div className="p-8 flex flex-col h-full">
                                    <div className="mb-6 text-center"><h2 className="text-2xl font-black text-gray-900 mb-1">{drill.name}</h2><p className="text-sm text-gray-500">Completa los ejercicios de esta página</p></div>
                                    <div className="flex-grow overflow-y-auto space-y-4 pr-2 mb-4">
                                        {drill.subDrills.map(subDrill => (
                                            <MiniScoringPanel key={subDrill.id} drill={subDrill} examId={examId} updateScore={updateScore} allExamScores={allExamScores} />
                                        ))}
                                    </div>
                                    <button onClick={onNextDrill} className="w-full mt-auto bg-gray-800 hover:bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg uppercase text-sm flex justify-center gap-2">{isLastDrill ? "Guardar y Salir" : "Siguiente Página"} {!isLastDrill && <ChevronRight size={18} />}</button>
                                </div>
                            ) : (
                                <ScoringPanel drill={drill} score={score} onScoreChange={onScoreChange} onReset={() => onScoreChange(0)} onNext={onNextDrill} isLast={isLastDrill} level={level} onClose={onClose} />
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- RESTO DE LA APP ---
        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState("");
            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 px-4">
                    <div className="max-w-md w-full bg-white p-8 rounded-xl shadow-lg border border-gray-200 text-center">
                        <div className="bg-green-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-md"><Target className="text-white w-8 h-8" /></div>
                        <h1 className="text-2xl font-extrabold text-gray-800 mb-2">TIRO MAESTRO</h1>
                        <p className="text-gray-500 mb-6">Ingresa tu nombre para guardar tu progreso</p>
                        <form onSubmit={(e) => { e.preventDefault(); if(username.trim()) onLogin(username.trim()); }}>
                            <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="Tu Nombre" className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-green-500 focus:outline-none" autoFocus />
                            <button type="submit" disabled={!username.trim()} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition shadow-md disabled:opacity-50">Comenzar Entrenamiento</button>
                        </form>
                    </div>
                </div>
            );
        };

        const ExamCard = ({ exam, onSelect }) => (
            <div onClick={() => onSelect(exam)} className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 hover:shadow-xl hover:border-green-500 hover:-translate-y-1 transition-all duration-300 cursor-pointer group relative overflow-hidden">
                <div className="absolute top-0 right-0 bg-gradient-to-br from-gray-50 to-gray-100 w-24 h-24 rounded-bl-full -mr-10 -mt-10 transition-colors group-hover:from-green-50 group-hover:to-green-100"></div>
                <div className="flex items-center gap-4 mb-4 relative z-10">
                    <div className="p-3 bg-gray-100 rounded-xl group-hover:bg-green-600 group-hover:text-white transition-colors duration-300 text-gray-700 shadow-sm">
                        {exam.id === 'I' && <RotateCcw size={28} />}
                        {exam.id === 'II' && <Shield size={28} />}
                        {exam.id === 'III' && <Trophy size={28} />}
                        {['IV', 'V', 'VI'].includes(exam.id) && <BookOpen size={28} />}
                    </div>
                    <h2 className="text-xl font-bold text-gray-800 group-hover:text-green-700 transition-colors">{exam.title}</h2>
                </div>
                <p className="text-gray-500 text-sm mb-6 leading-relaxed relative z-10">{exam.desc}</p>
                <div className="text-green-600 text-sm font-bold flex items-center gap-2 group-hover:translate-x-2 transition-transform">Iniciar Evaluación <ChevronLeft className="rotate-180 w-4 h-4" /></div>
            </div>
        );

        const ExamDetail = ({ exam, onBack, user, scores, updateScore, resetExamScore }) => {
            const [activeDrill, setActiveDrill] = useState(null);
            const [level, setLevel] = useState("Bachelors");
            const currentDrills = useMemo(() => (exam.id !== 'II' ? exam.drills : exam.drills), [exam, level]);
            const handleResetExam = () => { if(confirm("¿Estás seguro de reiniciar este examen?")) resetExamScore(exam.id); };
            
            const handleNextDrill = () => {
                if (!activeDrill) return;
                const currentIndex = currentDrills.findIndex(d => d.id === activeDrill.id);
                if (currentIndex >= 0 && currentIndex < currentDrills.length - 1) setActiveDrill(currentDrills[currentIndex + 1]);
                else setActiveDrill(null);
            };
            const isLastDrill = activeDrill ? currentDrills.findIndex(d => d.id === activeDrill.id) === currentDrills.length - 1 : false;

            return (
                <div className="max-w-6xl mx-auto p-6 pb-24">
                    <div className="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-4">
                        <div className="flex items-center gap-4"><button onClick={onBack} className="p-2 bg-white border border-gray-200 rounded-lg text-gray-500 hover:bg-gray-50 shadow-sm"><ChevronLeft size={24} /></button><div><h2 className="text-3xl font-black text-gray-900">{exam.title}</h2><p className="text-gray-500">{exam.desc}</p></div></div>
                        <div className="flex items-center gap-3">
                            <button onClick={handleResetExam} className="flex items-center gap-2 px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg font-bold text-sm transition border border-transparent hover:border-red-100"><RotateCcw size={16} /> Reiniciar Nivel</button>
                            {exam.id === 'II' && <div className="flex bg-white p-1.5 rounded-xl border border-gray-200 shadow-sm">{['Bachelors', 'Masters', 'Doctorate'].map(l => <button key={l} onClick={() => setLevel(l)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${level === l ? 'bg-gray-900 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}>{l === 'Bachelors' ? 'Licenciatura' : l === 'Masters' ? 'Maestría' : 'Doctorado'}</button>)}</div>}
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {currentDrills.map((drill) => {
                            let currentScore = 0;
                            let maxDisplay = 0;
                            if (drill.isGroup) {
                                drill.subDrills.forEach(sd => { currentScore += (scores[exam.id] ? (scores[exam.id][sd.id] || 0) : 0); maxDisplay += sd.max_score; });
                            } else {
                                currentScore = scores[exam.id] ? (scores[exam.id][drill.id] || 0) : 0;
                                maxDisplay = (typeof drill.max_score === 'object' ? drill.max_score[level] : drill.max_score) || 10;
                            }
                            return (
                                <div key={drill.id} onClick={() => setActiveDrill(drill)} className="bg-white border border-gray-200 rounded-xl p-5 cursor-pointer hover:shadow-lg hover:border-green-400 transition-all group relative overflow-hidden">
                                    <div className="flex justify-between items-start mb-4 relative z-10">
                                        <div className="bg-gray-100 text-gray-600 font-bold w-12 h-12 rounded-lg flex items-center justify-center group-hover:bg-green-100 group-hover:text-green-700 text-lg">{drill.id.split('-')[0]}</div>
                                        {currentScore > 0 && <CheckCircle className="text-green-500" size={24} />}
                                        {drill.isGroup && <span className="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded">Multi</span>}
                                    </div>
                                    <h3 className="font-bold text-lg text-gray-800 mb-1 group-hover:text-green-700 transition-colors relative z-10">{drill.name}</h3>
                                    <p className="text-sm text-gray-500 mb-4 line-clamp-2 relative z-10">{drill.desc}</p>
                                    <div className="w-full bg-gray-100 rounded-full h-1.5 mt-2 overflow-hidden"><div className="bg-green-500 h-1.5 rounded-full transition-all duration-500" style={{ width: `${(currentScore / maxDisplay) * 100}%` }}></div></div>
                                </div>
                            );
                        })}
                    </div>
                    {activeDrill && <PracticeModalFinal drill={activeDrill} score={scores[exam.id] ? (scores[exam.id][activeDrill.id] || 0) : 0} onScoreChange={(val) => updateScore(exam.id, activeDrill.id, val)} onClose={() => setActiveDrill(null)} onNextDrill={handleNextDrill} isLastDrill={isLastDrill} level={level} examId={exam.id} updateScore={updateScore} allExamScores={scores[exam.id] || {}} />}
                </div>
            );
        };

        const UserProfile = ({ user, scores, goBack }) => {
            const totalScore = useMemo(() => { let sum = 0; Object.keys(examsData).forEach(k => { const s = scores[k] || {}; Object.values(s).forEach(v => sum += Number(v) || 0); }); return sum; }, [scores]);
            const currentLevel = [...LEVELS].reverse().find(l => totalScore >= l.min) || LEVELS[0];
            return (
                <div className="max-w-4xl mx-auto p-4"><button onClick={goBack} className="flex items-center text-gray-500 hover:text-gray-800 mb-6"><ChevronLeft size={20} /> Volver</button><div className="bg-white rounded-2xl shadow-md border border-gray-200 p-6"><div className="flex items-center gap-4 mb-6"><div className="w-16 h-16 rounded-full bg-green-600 text-white flex items-center justify-center text-2xl font-bold">{user.charAt(0).toUpperCase()}</div><div><h2 className="text-2xl font-bold">{user}</h2><p className="text-gray-500">Puntos Totales: <span className="font-bold text-gray-900">{totalScore}</span></p></div></div><div className="bg-gray-50 p-4 rounded-xl border border-gray-100 text-center"><span className="text-sm font-bold text-gray-400 uppercase">Nivel Actual</span><h3 className={`text-3xl font-black ${currentLevel.color}`}>{currentLevel.name_es}</h3></div></div></div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(localStorage.getItem('bu_current_user') || null);
            const [view, setView] = useState(user ? 'home' : 'login'); 
            const [selectedExam, setSelectedExam] = useState(null);
            const [allScores, setAllScores] = useState({});
            useEffect(() => { if (user) { const saved = localStorage.getItem(`bu_scores_${user}`); setAllScores(saved ? JSON.parse(saved) : {}); setView('home'); } else { setView('login'); } }, [user]);
            const handleLogin = (u) => { localStorage.setItem('bu_current_user', u); setUser(u); };
            const handleLogout = () => { localStorage.removeItem('bu_current_user'); setUser(null); setAllScores({}); setView('login'); };
            const updateScore = (eId, dId, val) => { const ns = { ...allScores, [eId]: { ...(allScores[eId] || {}), [dId]: val } }; setAllScores(ns); localStorage.setItem(`bu_scores_${user}`, JSON.stringify(ns)); };
            const resetExamScore = (eId) => { const ns = { ...allScores }; delete ns[eId]; setAllScores(ns); localStorage.setItem(`bu_scores_${user}`, JSON.stringify(ns)); };
            if (!user) return <LoginScreen onLogin={handleLogin} />;
            return (
                <div className="min-h-screen flex flex-col bg-gray-100 font-sans text-gray-900">
                    <header className="bg-gray-900 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-40 border-b border-gray-800"><div className="flex items-center gap-3 cursor-pointer group" onClick={() => {setSelectedExam(null); setView('home');}}><div className="bg-gradient-to-br from-green-500 to-green-700 p-2 rounded-xl shadow-lg group-hover:scale-105 transition-transform duration-200"><Target className="text-white w-7 h-7" /></div><div className="hidden sm:block"><h1 className="text-2xl font-extrabold tracking-tight leading-none">TIRO MAESTRO</h1><p className="text-[10px] text-gray-400 uppercase tracking-widest">Billiard University App</p></div></div><div className="flex gap-3 items-center">{user && <React.Fragment><button onClick={() => setView('profile')} className="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-white pl-2 pr-4 py-1.5 rounded-full transition text-sm border border-gray-700 shadow-sm group"><div className="w-7 h-7 rounded-full bg-indigo-500 flex items-center justify-center text-xs font-bold group-hover:bg-indigo-400 transition-colors">{user.charAt(0).toUpperCase()}</div><span className="font-medium hidden sm:inline">{user}</span></button><button onClick={handleLogout} className="p-2 text-gray-400 hover:text-red-400 hover:bg-gray-800 rounded-lg transition"><LogOut size={20} /></button></React.Fragment>}</div></header>
                    <main className="flex-grow">
                        {view === 'home' && <div className="max-w-5xl mx-auto p-6"><div className="text-center mb-12 mt-8"><h1 className="text-5xl font-black text-gray-900 mb-4 tracking-tight">TIRO MAESTRO</h1><p className="text-xl text-gray-500 max-w-2xl mx-auto font-light">Plan de Evaluación Profesional</p></div><div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-16">{Object.values(examsData).map(exam => <ExamCard key={exam.id} exam={exam} onSelect={(e) => { setSelectedExam(e); setView('exam'); }} />)}</div></div>}
                        {view === 'profile' && <UserProfile user={user} scores={allScores} goBack={() => setView('home')} />}
                        {view === 'exam' && selectedExam && <ExamDetail exam={selectedExam} onBack={() => { setSelectedExam(null); setView('home'); }} user={user} scores={allScores} updateScore={updateScore} resetExamScore={resetExamScore} />}
                    </main>
                    <footer className="bg-white border-t border-gray-200 p-8 text-center"><div className="max-w-2xl mx-auto"><div className="flex justify-center items-center gap-2 mb-4 text-gray-400"><GraduationCap size={24} /></div><p className="text-sm text-gray-500 mb-2 font-medium">&copy; 2025 Tiro Maestro App</p><p className="text-xs text-gray-400 leading-relaxed">Basado en el currículo del <strong className="text-gray-600">Dr. Dave Alciatore</strong>.<br/>Desarrollado por <strong className="text-gray-600">Juan Miguel Rios Redondo</strong>.</p><a href="https://billiarduniversity.org/" target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 text-blue-600 hover:text-blue-800 font-bold mt-3 text-sm hover:underline">billiarduniversity.org <ExternalLink size={12} /></a></div></footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

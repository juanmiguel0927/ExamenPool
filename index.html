import React, { useState, useEffect, useMemo } from 'react';
import { BookOpen, Trophy, Target, Shield, RotateCcw, ChevronLeft, Globe, Info, CheckCircle, Save, Trash2, ExternalLink, AlertCircle, Plus, Minus, User, LogOut, Hash, Check, X, BarChart2, GraduationCap } from 'lucide-react';

// --- CONFIGURACIÓN ---

const PDF_URL = "https://cdn.jsdelivr.net/gh/juanmiguel0927/ExamenPool@67236543a59fea85da25afc8d1d8c9afd7c9383b/All.pdf";

const LEVELS = [
    { name_es: "Novato", name_en: "Novice", min: 0, color: "text-gray-500", bg: "bg-gray-100" },
    { name_es: "Principiante", name_en: "Beginner", min: 50, color: "text-green-500", bg: "bg-green-100" },
    { name_es: "Aficionado", name_en: "Amateur", min: 100, color: "text-blue-500", bg: "bg-blue-100" },
    { name_es: "Intermedio", name_en: "Intermediate", min: 150, color: "text-indigo-500", bg: "bg-indigo-100" },
    { name_es: "Avanzado", name_en: "Advanced", min: 200, color: "text-purple-500", bg: "bg-purple-100" },
    { name_es: "Semiprofesional", name_en: "Semi-Pro", min: 250, color: "text-orange-500", bg: "bg-orange-100" },
    { name_es: "Maestro", name_en: "Master", min: 300, color: "text-red-600", bg: "bg-red-100" },
    { name_es: "Leyenda", name_en: "Legend", min: 350, color: "text-yellow-600", bg: "bg-yellow-100" }
];

// --- DATOS ---

const glossaryTerms = [
    { term: "CB (Cue Ball)", def_en: "The white ball struck by the cue.", def_es: "Bola Blanca (Mingo). La bola blanca golpeada por el taco." },
    { term: "OB (Object Ball)", def_en: "The ball the cue ball strikes.", def_es: "Bola Objetivo. La bola a la que golpea la bola blanca." },
    { term: "BIH (Ball In Hand)", def_en: "Player can place the cue ball anywhere on the table.", def_es: "Bola en Mano. El jugador puede colocar la bola blanca en cualquier lugar de la mesa." },
    { term: "Cut Shot", def_en: "A shot where the CB strikes the OB at an angle.", def_es: "Tiro de Corte / Fina. Un tiro donde la blanca golpea la objetivo en ángulo." },
    { term: "Stop Shot", def_en: "The CB stops immediately after contacting the OB.", def_es: "Tiro de Stop / Clavada. La blanca se detiene inmediatamente tras el impacto." },
    { term: "Follow Shot", def_en: "The CB continues forward after contact (top spin).", def_es: "Tiro Corrido / Follow. La blanca sigue hacia adelante (efecto arriba)." },
    { term: "Draw Shot", def_en: "The CB spins backwards after contact (back spin).", def_es: "Tiro de Retroceso / Draw / Jalar. La blanca retrocede (efecto abajo)." },
    { term: "Stun Shot", def_en: "The CB slides into the OB with no forward/backward roll.", def_es: "Tiro Seco / Stun. La blanca golpea deslizando sin rotación, saliendo en la línea tangente." },
    { term: "Ghost Ball", def_en: "Imaginary position of the CB at the moment of impact.", def_es: "Bola Fantasma. Posición imaginaria de la blanca en el momento del impacto." },
    { term: "Rail / Cushion", def_en: "The padded sides of the table.", def_es: "Banda. Los lados acolchados de la mesa." },
    { term: "Scratch", def_en: "Pocketing the Cue Ball (foul).", def_es: "Suicidio / Mingo / Falta. Embocar la bola blanca." },
    { term: "Diamond", def_en: "Markers on the rails used for aiming.", def_es: "Diamante. Marcadores en las bandas usados para apuntar." },
    { term: "Safety", def_en: "Defensive shot aiming to leave the opponent difficult.", def_es: "Defensa. Tiro defensivo para dejar al oponente en una situación difícil." },
    { term: "Bank Shot", def_en: "Driving an OB into a rail to pocket it.", def_es: "Tiro de Banda / Doblete. Golpear una bola objetivo contra una banda para embocarla." },
    { term: "Kick Shot", def_en: "Driving the CB into a rail to hit an OB.", def_es: "Tiro de Retruque / Bricol. Golpear la blanca contra una banda antes de dar a la objetivo." },
    { term: "Masse", def_en: "Curving the CB path using extreme elevation and spin.", def_es: "Massé. Curvar la trayectoria de la blanca usando elevación y efecto." }
];

const examsData = {
    I: {
        id: "I",
        title_en: "Exam I - Fundamentals",
        title_es: "Examen I - Fundamentos",
        desc_en: "Progressive drills to test stance, stroke, and basic cue ball control.",
        desc_es: "Ejercicios progresivos para evaluar postura, golpe y control básico de la bola blanca.",
        drills: [
            { 
                id: "F1", name_en: "Cut Shot Drill", name_es: "Tiro de Corte",
                desc_en: "Progressive practice. Start CB at pos 4. Pocket OB. Success: move back. Miss: move forward.",
                desc_es: "Práctica progresiva. Inicia CB en pos 4. Emboca OB. Éxito: atrás. Fallo: adelante.",
                max_score: 10, total_shots: 10, pdf_page: 1, scoringType: 'progressive',
                scoring_en: "Final Position + Bonus.", scoring_es: "Posición Final + Bono."
            },
            { 
                id: "F2", name_en: "Stop Shot Drill", name_es: "Tiro de Stop",
                desc_en: "Progressive. Stop CB within 1 ball of Ghost Ball position.",
                desc_es: "Progresivo. Detener CB a menos de 1 bola de la posición fantasma.",
                max_score: 10, total_shots: 10, pdf_page: 2, scoringType: 'progressive',
                scoring_en: "Final Position + Bonus.", scoring_es: "Posición Final + Bono."
            },
            { 
                id: "F3", name_en: "Follow Shot Drill", name_es: "Tiro Corrido (Follow)",
                desc_en: "Progressive. Follow to target rectangle in corner.",
                desc_es: "Progresivo. Corrido hacia el rectángulo objetivo en la esquina.",
                max_score: 10, total_shots: 10, pdf_page: 3, scoringType: 'progressive',
                scoring_en: "Final Position + Bonus.", scoring_es: "Posición Final + Bono."
            },
            { 
                id: "F4", name_en: "Draw Shot Drill", name_es: "Tiro de Retroceso (Draw)",
                desc_en: "Progressive. Draw CB back into the 2x1 diamond rectangle.",
                desc_es: "Progresivo. Retrocede la CB hacia el rectángulo de 2x1 diamantes.",
                max_score: 10, total_shots: 10, pdf_page: 4, scoringType: 'progressive',
                scoring_en: "Final Position + Bonus.", scoring_es: "Posición Final + Bono."
            },
            { 
                id: "F5", name_en: "Stun Shot Drill", name_es: "Tiro Seco (Stun)",
                desc_en: "Target moves. Stun CB to stop in target areas.",
                desc_es: "El objetivo se mueve. Stun a la CB para parar en áreas objetivo.",
                max_score: 10, total_shots: 10, pdf_page: 5, scoringType: 'progressive',
                scoring_en: "Final Target # + Bonus.", scoring_es: "# Objetivo Final + Bono."
            },
            { 
                id: "F6", name_en: "Ball Pocketing Drill", name_es: "Embocar Bolas",
                desc_en: "5 shots from each of 2 CB positions.",
                desc_es: "5 tiros desde cada una de las 2 posiciones de CB.",
                max_score: 10, total_shots: 10, pdf_page: 6, scoringType: 'count',
                scoring_en: "1 point per ball pocketed.", scoring_es: "1 punto por bola embocada."
            },
            { 
                id: "F7", name_en: "Wagon Wheel Drill", name_es: "Rueda de Carreta",
                desc_en: "Pocket OB and send CB to hit rail target balls.",
                desc_es: "Emboca OB y envía CB a golpear bolas objetivo en la banda.",
                max_score: 20, total_shots: 20, pdf_page: 7, scoringType: 'count',
                scoring_en: "1 point per success.", scoring_es: "1 punto por éxito."
            },
            { 
                id: "F8", name_en: "Grid Target Drill", name_es: "Objetivo en Rejilla",
                desc_en: "Pocket OB and leave CB in target rectangles.",
                desc_es: "Emboca OB y deja la CB en rectángulos objetivo.",
                max_score: 20, total_shots: 20, pdf_page: 8, scoringType: 'count',
                scoring_en: "1 point per success.", scoring_es: "1 punto por éxito."
            }
        ]
    },
    II: {
        id: "II",
        title_en: "Exam II - Skills",
        title_es: "Examen II - Habilidades",
        desc_en: "Real game situations separated by difficulty levels.",
        desc_es: "Situaciones reales de juego separadas por nivel de dificultad.",
        levels: ["Bachelors", "Masters", "Doctorate"],
        drills: [
            { id: "S1", name_en: "Line of Balls", name_es: "Línea de Bolas", max_score: {Bachelors: 4, Masters: 7, Doctorate: 10}, total_shots: 2, scoringType: 'best_of', desc_es: "Limpiar bolas en rotación. 2 Intentos, cuenta el mejor.", pdf_page: 9 },
            { id: "S2", name_en: "Rail Cut Shot", name_es: "Corte de Banda", max_score: {Bachelors: 6, Masters: 10, Doctorate: 14}, total_shots: 2, scoringType: 'best_of', desc_es: "Embocar bolas pegadas a banda. 2 Intentos, cuenta el mejor.", pdf_page: 10 },
            { id: "S3", name_en: "9-Ball Patterns", name_es: "Patrones de Bola 9", max_score: 10, total_shots: 3, scoringType: 'sum_lowest', desc_es: "3 configuraciones. Suma de los 2 peores puntajes.", pdf_page: 11 },
            { id: "S4", name_en: "8-Ball Patterns", name_es: "Patrones de Bola 8", max_score: 10, total_shots: 3, scoringType: 'sum_lowest', desc_es: "3 configuraciones. Suma de los 2 peores puntajes.", pdf_page: 14 },
            { id: "S5", name_en: "Safety Drill", name_es: "Defensas", max_score: {Bachelors: 6, Masters: 10, Doctorate: 14}, total_shots: {Bachelors: 6, Masters: 10, Doctorate: 14}, scoringType: 'count', desc_es: "Esconder CB detrás de obstáculos.", pdf_page: 17 },
            { id: "S6", name_en: "Kick Shot", name_es: "Tiro de Retruque", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', desc_es: "Golpear OBs rebotando en banda.", pdf_page: 18 },
            { id: "S7", name_en: "Bank Shot", name_es: "Tiro de Banda", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', desc_es: "Embocar OBs rebotando en banda opuesta.", pdf_page: 19 },
            { id: "S8", name_en: "Elevated Cue", name_es: "Tiro Elevado", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', desc_es: "Tirar por encima de obstáculos.", pdf_page: 20 },
            { id: "S9", name_en: "Jump/Masse", name_es: "Salto o Massé", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', desc_es: "Saltar o curvar alrededor de obstáculo.", pdf_page: 21 },
            { id: "S10", name_en: "Break Drill", name_es: "Saque", max_score: 5, total_shots: 3, scoringType: 'median', desc_es: "3 Saques. Se toma la puntuación media.", pdf_page: 22 }
        ]
    },
    III: {
        id: "III",
        title_en: "Exam III - Advanced Shots",
        title_es: "Examen III - Tiros Avanzados",
        desc_en: "25 specific advanced shots. 4 pts for 1st try, 2 for 2nd, 1 for 3rd.",
        desc_es: "25 tiros avanzados específicos. 4 ptos al 1er intento, 2 al 2º, 1 al 3º.",
        drills: Array.from({length: 25}, (_, i) => ({
            id: `A${i+1}`, 
            name_en: `Shot A${i+1}`, 
            name_es: `Tiro A${i+1}`,
            desc_es: "Ver PDF para diagrama específico.",
            max_score: 4,
            total_shots: 3,
            scoringType: 'weighted', 
            pdf_page: 51 + Math.floor(i/2) 
        }))
    },
    IV: {
        id: "IV",
        title_en: "RDS",
        title_es: "RDS - Sistema de Limpieza",
        desc_es: "16 Niveles. Sacar y limpiar mesa con reglas variables.",
        drills: Array.from({length: 16}, (_, i) => ({
            id: `L${i+1}`, 
            name_es: `Nivel ${i+1}`,
            desc_es: i < 5 ? "X bolas, Cualquier Orden." : "Reglas complejas.",
            max_score: 100,
            total_shots: 1,
            scoringType: 'pass_fail',
            pdf_page: 65 + Math.floor(i/4)
        }))
    },
    V: {
        id: "V",
        title_en: "PPC",
        title_es: "PPC - Desafío de Colocación",
        desc_es: "18 Configuraciones jugadas consecutivamente.",
        drills: [
            { 
                id: "PPC", name_es: "Desafío Completo", 
                desc_es: "Jugar las 18 configuraciones. Inicia con 100pts.", 
                max_score: 100, total_shots: 18, scoringType: 'deduction', pdf_page: 68
            }
        ]
    },
    VI: {
        id: "VI",
        title_en: "Safety Challenge",
        title_es: "Desafío de Seguridad",
        desc_es: "20 Tiros defensivos. Esconder la bola blanca.",
        drills: Array.from({length: 20}, (_, i) => ({
            id: `Safe${i+1}`, 
            name_es: `Defensa ${i+1}`,
            desc_es: "Ejecutar tiro defensivo específico.",
            max_score: 1,
            total_shots: 1,
            scoringType: 'count',
            pdf_page: 78 + Math.floor(i/2)
        }))
    }
};

// --- COMPONENTES DE PUNTUACIÓN INTELIGENTE ---

const ScoringPanel = ({ drill, score, onScoreChange, lang, level, onClose }) => {
    const currentScore = Number(score) || 0;

    let totalShots = drill.total_shots;
    if (typeof totalShots === 'object' && totalShots !== null) {
        totalShots = totalShots[level] || 10;
    }
    
    let maxScore = drill.max_score;
    if (typeof maxScore === 'object' && maxScore !== null) {
        maxScore = maxScore[level] || 10;
    }

    // Lógica específica para examen progresivo
    const isProgressive = drill.scoringType === 'progressive';
    const displayTotal = isProgressive ? 10 : maxScore; // En progresivo siempre es base 10 aunque visualmente sea posición

    return (
        <div className="bg-white rounded-lg p-6 flex flex-col h-full justify-between">
            {/* Header */}
            <div className="border-b border-gray-100 pb-4 mb-4">
                <div className="flex justify-between items-center mb-1">
                    <h3 className="font-black text-xl text-gray-800 uppercase tracking-tight">{lang === 'en' ? drill.name_en : drill.name_es}</h3>
                    <span className="text-xs font-bold text-gray-400">{drill.id}</span>
                </div>
                
                <div className="bg-gray-50 rounded-md p-2 flex justify-between items-center text-xs text-gray-600">
                    <span>{lang === 'en' ? 'Best Score:' : 'Mejor Puntuación:'} <span className="font-bold">{currentScore} / {displayTotal}</span></span>
                </div>
            </div>

            {/* Main Display */}
            <div className="flex-grow flex flex-col items-center justify-center mb-8">
                <div className="text-center mb-8">
                    <div className="text-5xl font-black text-blue-600 mb-2 flex items-center justify-center gap-2">
                        {currentScore} <span className="text-2xl text-gray-400 font-normal">/ {totalShots}</span>
                    </div>
                    <div className="text-xl font-bold text-gray-500">
                        {lang === 'en' ? 'Hits / Attempts' : 'Aciertos / Intentos'}
                    </div>
                </div>

                {/* Action Buttons - Red/Green Big Buttons */}
                <div className="flex gap-4 w-full">
                    <button 
                        onClick={() => onScoreChange(Math.max(0, currentScore - 1))}
                        className="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold text-xl py-6 rounded-lg shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2"
                    >
                        {lang === 'en' ? 'Miss' : 'Fallo'}
                    </button>
                    <button 
                        onClick={() => onScoreChange(Math.min(maxScore, currentScore + 1))}
                        className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold text-xl py-6 rounded-lg shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2"
                    >
                        {lang === 'en' ? 'Hit' : 'Acierto'}
                    </button>
                </div>
            </div>

            {/* Footer Button */}
            <button 
                onClick={onClose}
                className="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg transition shadow-md text-sm uppercase tracking-wider"
            >
                {lang === 'en' ? 'Save Progress & Exit' : 'Guardar Progreso y Salir'}
            </button>
        </div>
    );
};

const LoginScreen = ({ onLogin, lang }) => {
    const [username, setUsername] = useState("");

    const handleSubmit = (e) => {
        e.preventDefault();
        if (username.trim()) {
            onLogin(username.trim());
        }
    };

    return (
        <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 px-4">
            <div className="max-w-md w-full bg-white p-8 rounded-xl shadow-lg border border-gray-200 text-center">
                <div className="bg-green-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-md">
                    <Target className="text-white w-8 h-8" />
                </div>
                <h1 className="text-2xl font-extrabold text-gray-800 mb-2">TIRO MAESTRO</h1>
                <p className="text-gray-500 mb-6">{lang === 'en' ? 'Enter your name to start tracking your progress' : 'Ingresa tu nombre para guardar tu progreso'}</p>
                
                <form onSubmit={handleSubmit}>
                    <input 
                        type="text"
                        value={username}
                        onChange={(e) => setUsername(e.target.value)}
                        placeholder={lang === 'en' ? "Your Name" : "Tu Nombre"}
                        className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-green-500 focus:outline-none"
                        autoFocus
                    />
                    <button 
                        type="submit"
                        disabled={!username.trim()}
                        className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {lang === 'en' ? 'Start Training' : 'Comenzar Entrenamiento'}
                    </button>
                </form>
            </div>
        </div>
    );
};

const UserProfile = ({ user, scores, lang, goBack }) => {
    const totalScore = useMemo(() => {
        let sum = 0;
        Object.keys(examsData).forEach(examKey => {
            const examScores = scores[examKey] || {};
            Object.values(examScores).forEach(val => {
                sum += Number(val) || 0;
            });
        });
        return sum;
    }, [scores]);

    const currentLevel = useMemo(() => {
        const reversed = [...LEVELS].reverse();
        return reversed.find(l => totalScore >= l.min) || LEVELS[0];
    }, [totalScore]);

    const nextLevel = LEVELS.find(l => l.min > totalScore);
    const progress = nextLevel 
        ? ((totalScore - currentLevel.min) / (nextLevel.min - currentLevel.min)) * 100 
        : 100;

    return (
        <div className="max-w-4xl mx-auto p-4 pb-20">
            <button onClick={goBack} className="flex items-center text-gray-500 hover:text-gray-800 mb-6 transition">
                <ChevronLeft size={20} /> {lang === 'en' ? 'Back to Menu' : 'Volver al Menú'}
            </button>

            <div className="bg-white rounded-2xl shadow-md overflow-hidden border border-gray-200 mb-6">
                <div className="bg-gray-900 p-6 text-white flex items-center gap-4">
                    <div className="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center text-2xl font-bold border-4 border-white">
                        {user.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <h2 className="text-2xl font-bold">{user}</h2>
                        <p className="opacity-80">{lang === 'en' ? 'Billiard Student' : 'Estudiante de Billar'}</p>
                    </div>
                </div>

                <div className="p-6">
                    <div className="flex flex-col md:flex-row gap-6 justify-between items-center text-center md:text-left mb-8">
                        <div>
                            <p className="text-gray-500 text-sm font-semibold uppercase tracking-wider">{lang === 'en' ? 'Current Rank' : 'Rango Actual'}</p>
                            <h3 className={`text-4xl font-black ${currentLevel.color}`}>
                                {lang === 'en' ? currentLevel.name_en : currentLevel.name_es}
                            </h3>
                        </div>
                        <div className="bg-gray-50 px-8 py-4 rounded-xl border border-gray-100">
                            <p className="text-gray-500 text-sm font-semibold uppercase tracking-wider">{lang === 'en' ? 'Total Score' : 'Puntuación Total'}</p>
                            <p className="text-3xl font-bold text-gray-800">{totalScore} <span className="text-sm font-normal text-gray-400">pts</span></p>
                        </div>
                    </div>

                    <div className="mb-2">
                        <div className="flex justify-between text-sm mb-2 font-medium text-gray-600">
                            <span>{lang === 'en' ? 'Progress to next level' : 'Progreso al siguiente nivel'}</span>
                            {nextLevel && <span>{totalScore} / {nextLevel.min}</span>}
                        </div>
                        <div className="h-4 w-full bg-gray-200 rounded-full overflow-hidden">
                            <div className="h-full bg-green-500 transition-all duration-1000 ease-out" style={{ width: `${progress}%` }}></div>
                        </div>
                        {nextLevel ? (
                            <p className="text-xs text-gray-400 mt-2 text-center">
                                {lang === 'en' ? `Need ${nextLevel.min - totalScore} more points for` : `Necesitas ${nextLevel.min - totalScore} puntos más para`} <span className="font-bold">{lang === 'en' ? nextLevel.name_en : nextLevel.name_es}</span>
                            </p>
                        ) : (
                            <p className="text-xs text-green-600 mt-2 text-center font-bold">
                                {lang === 'en' ? 'Max level reached!' : '¡Nivel máximo alcanzado!'}
                            </p>
                        )}
                    </div>
                </div>
            </div>

            <h3 className="text-xl font-bold text-gray-800 mb-4">{lang === 'en' ? 'Exam History' : 'Historial de Exámenes'}</h3>
            <div className="grid md:grid-cols-2 gap-4">
                {Object.keys(examsData).map(key => {
                    const exam = examsData[key];
                    const s = scores[key] || {};
                    const total = Object.values(s).reduce((a,b)=>a+Number(b),0);
                    
                    return (
                        <div key={key} className="bg-white p-4 rounded-lg border border-gray-200 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className={`p-2 rounded-lg ${total > 0 ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}`}>
                                    <Trophy size={20} />
                                </div>
                                <div>
                                    <h4 className="font-bold text-gray-800">{lang === 'en' ? exam.title_en : exam.title_es}</h4>
                                    <p className="text-xs text-gray-500">{total > 0 ? (lang === 'en' ? 'In Progress' : 'En Progreso') : (lang === 'en' ? 'Not Started' : 'No Iniciado')}</p>
                                </div>
                            </div>
                            <span className="text-xl font-bold text-gray-800">{total}</span>
                        </div>
                    )
                })}
            </div>
        </div>
    );
};

// --- MAIN APP CONTROLLER ---

const Header = ({ lang, setLang, goHome, onProfileClick, user, onLogout }) => (
    <header className="bg-gray-900 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-50 border-b border-gray-800">
        <div className="flex items-center gap-3 cursor-pointer group" onClick={goHome}>
            <div className="bg-gradient-to-br from-green-500 to-green-700 p-2 rounded-xl shadow-lg group-hover:scale-105 transition-transform duration-200">
                <Target className="text-white w-7 h-7" />
            </div>
            <div className="hidden sm:block">
                <h1 className="text-2xl font-extrabold tracking-tight leading-none">TIRO MAESTRO</h1>
                <p className="text-[10px] text-gray-400 uppercase tracking-widest">Billiard University App</p>
            </div>
        </div>
        <div className="flex gap-3 items-center">
            {user && (
                <>
                <button 
                    onClick={onProfileClick}
                    className="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-white pl-2 pr-4 py-1.5 rounded-full transition text-sm border border-gray-700 shadow-sm group"
                >
                    <div className="w-7 h-7 rounded-full bg-indigo-500 flex items-center justify-center text-xs font-bold group-hover:bg-indigo-400 transition-colors">
                        {user.charAt(0).toUpperCase()}
                    </div>
                    <span className="font-medium hidden sm:inline">{user}</span>
                </button>
                <button onClick={onLogout} className="p-2 text-gray-400 hover:text-red-400 hover:bg-gray-800 rounded-lg transition">
                    <LogOut size={20} />
                </button>
                </>
            )}
            <button 
                onClick={() => setLang(lang === 'en' ? 'es' : 'en')}
                className="flex items-center gap-1 bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded-lg text-xs font-bold transition border border-gray-700 ml-1 text-gray-300"
            >
                <Globe size={14} />
                {lang === 'en' ? 'ES' : 'EN'}
            </button>
        </div>
    </header>
);

const ExamCard = ({ exam, lang, onSelect }) => (
    <div 
        onClick={() => onSelect(exam)}
        className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 hover:shadow-xl hover:border-green-500 hover:-translate-y-1 transition-all duration-300 cursor-pointer group relative overflow-hidden"
    >
        <div className="absolute top-0 right-0 bg-gradient-to-br from-gray-50 to-gray-100 w-24 h-24 rounded-bl-full -mr-10 -mt-10 transition-colors group-hover:from-green-50 group-hover:to-green-100"></div>
        <div className="flex items-center gap-4 mb-4 relative z-10">
            <div className="p-3 bg-gray-100 rounded-xl group-hover:bg-green-600 group-hover:text-white transition-colors duration-300 text-gray-700 shadow-sm">
                {exam.id === 'I' && <RotateCcw size={28} />}
                {exam.id === 'II' && <Shield size={28} />}
                {exam.id === 'III' && <Trophy size={28} />}
                {['IV', 'V', 'VI'].includes(exam.id) && <BookOpen size={28} />}
            </div>
            <h2 className="text-xl font-bold text-gray-800 group-hover:text-green-700 transition-colors">{lang === 'en' ? exam.title_en : exam.title_es}</h2>
        </div>
        <p className="text-gray-500 text-sm mb-6 leading-relaxed relative z-10">{lang === 'en' ? exam.desc_en : exam.desc_es}</p>
        <div className="text-green-600 text-sm font-bold flex items-center gap-2 group-hover:translate-x-2 transition-transform">
            {lang === 'en' ? 'Start Assessment' : 'Iniciar Evaluación'} <ChevronLeft className="rotate-180 w-4 h-4" />
        </div>
    </div>
);

const Glossary = ({ lang, goBack }) => {
    const [search, setSearch] = useState("");
    
    const filteredTerms = glossaryTerms.filter(t => 
        t.term.toLowerCase().includes(search.toLowerCase()) || 
        t.def_en.toLowerCase().includes(search.toLowerCase()) ||
        t.def_es.toLowerCase().includes(search.toLowerCase())
    );

    return (
        <div className="max-w-3xl mx-auto p-4">
            <button onClick={goBack} className="flex items-center text-gray-500 hover:text-gray-800 mb-6 transition">
                <ChevronLeft size={20} /> {lang === 'en' ? 'Back to Menu' : 'Volver al Menú'}
            </button>
            <h2 className="text-3xl font-bold mb-6 flex items-center gap-3 text-gray-900">
                <BookOpen className="text-blue-600" />
                {lang === 'en' ? 'Billiard Glossary' : 'Glosario de Billar'}
            </h2>
            <input 
                type="text" 
                placeholder={lang === 'en' ? "Search terms (e.g. Stun, Draw)..." : "Buscar términos (ej. Stun, Retroceso)..."}
                className="w-full p-4 pl-12 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                value={search}
                onChange={(e) => setSearch(e.target.value)}
            />
            <div className="grid gap-4">
                {filteredTerms.map((item, idx) => (
                    <div key={idx} className="bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                        <h3 className="font-bold text-xl text-blue-900 mb-2">{item.term}</h3>
                        <div className="space-y-1">
                            <p className="text-gray-600 text-sm"><strong className="text-xs uppercase tracking-wide text-gray-400 w-6 inline-block">EN:</strong> {item.def_en}</p>
                            <p className="text-gray-600 text-sm"><strong className="text-xs uppercase tracking-wide text-gray-400 w-6 inline-block">ES:</strong> {item.def_es}</p>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}

// --- MODAL LAYOUT FOR EXAM DETAIL ---

const ExamDetail = ({ exam, lang, onBack, user, scores, updateScore }) => {
    const [activeDrill, setActiveDrill] = useState(null);
    const [level, setLevel] = useState("Bachelors");

    const currentDrills = useMemo(() => {
        if (exam.id !== 'II') return exam.drills;
        return exam.drills; 
    }, [exam, level]);

    return (
        <div className="max-w-5xl mx-auto p-6 pb-24">
            {/* Header */}
            <div className="flex items-center justify-between mb-8">
                <div className="flex items-center gap-4">
                    <button onClick={onBack} className="p-2 bg-white border border-gray-200 rounded-lg text-gray-500 hover:bg-gray-50 transition shadow-sm">
                        <ChevronLeft size={24} />
                    </button>
                    <div>
                        <h2 className="text-3xl font-black text-gray-900">{lang === 'en' ? exam.title_en : exam.title_es}</h2>
                        <p className="text-gray-500">{lang === 'en' ? exam.desc_en : exam.desc_es}</p>
                    </div>
                </div>
                {exam.id === 'II' && (
                    <div className="flex bg-white p-1.5 rounded-xl border border-gray-200 shadow-sm">
                        {['Bachelors', 'Masters', 'Doctorate'].map(l => (
                            <button 
                                key={l}
                                onClick={() => setLevel(l)}
                                className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${level === l ? 'bg-gray-900 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900'}`}
                            >
                                {lang === 'es' && l === 'Bachelors' ? 'Licenciatura' : 
                                 lang === 'es' && l === 'Masters' ? 'Maestría' : 
                                 lang === 'es' && l === 'Doctorate' ? 'Doctorado' : l}
                            </button>
                        ))}
                    </div>
                )}
            </div>

            {/* Drill Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {currentDrills.map((drill) => {
                    const currentScore = scores[exam.id] ? (scores[exam.id][drill.id] || 0) : 0;
                    return (
                        <div 
                            key={drill.id} 
                            onClick={() => setActiveDrill(drill)}
                            className="bg-white border border-gray-200 rounded-xl p-5 cursor-pointer hover:shadow-lg hover:border-green-400 transition-all group"
                        >
                            <div className="flex justify-between items-start mb-4">
                                <div className="bg-gray-100 text-gray-600 font-bold w-10 h-10 rounded-lg flex items-center justify-center group-hover:bg-green-100 group-hover:text-green-700 transition-colors">
                                    {drill.id}
                                </div>
                                {currentScore > 0 && <CheckCircle className="text-green-500" size={20} />}
                            </div>
                            <h3 className="font-bold text-lg text-gray-800 mb-1 group-hover:text-green-700 transition-colors">{lang === 'en' ? drill.name_en : drill.name_es}</h3>
                            <p className="text-sm text-gray-500 mb-4 line-clamp-2">{lang === 'en' ? drill.desc_en : drill.desc_es}</p>
                            <div className="flex items-center text-xs font-bold text-gray-400 uppercase tracking-wider">
                                Score: <span className="text-gray-900 ml-1 text-base">{currentScore}</span>
                            </div>
                        </div>
                    );
                })}
            </div>

            {/* MODAL OVERLAY */}
            {activeDrill && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white w-full max-w-6xl h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row relative animate-in zoom-in-95 duration-200">
                        {/* Close Button */}
                        <button 
                            onClick={() => setActiveDrill(null)}
                            className="absolute top-4 right-4 z-50 bg-white/80 hover:bg-white text-gray-800 p-2 rounded-full shadow-md transition"
                        >
                            <X size={24} />
                        </button>

                        {/* LEFT COLUMN: PDF VIEWER */}
                        <div className="w-full md:w-2/3 bg-gray-100 border-r border-gray-200 relative">
                             <div className="absolute top-0 left-0 w-full bg-white/90 backdrop-blur px-4 py-2 border-b border-gray-200 flex justify-between items-center z-10">
                                <div className="flex items-center gap-2 text-sm font-bold text-gray-600">
                                    <BookOpen size={16} /> 
                                    {lang === 'en' ? 'Exercise Diagram' : 'Diagrama del Ejercicio'}
                                </div>
                                <span className="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600 font-mono">Page {activeDrill.pdf_page}</span>
                             </div>
                             {activeDrill.pdf_page && (
                                <iframe 
                                    src={`${PDF_URL}#page=${activeDrill.pdf_page}&toolbar=0&view=FitH`}
                                    className="w-full h-full"
                                    title="Drill Diagram"
                                />
                             )}
                        </div>

                        {/* RIGHT COLUMN: SCORING CONTROLS */}
                        <div className="w-full md:w-1/3 bg-white flex flex-col">
                            <div className="p-6 flex-grow overflow-y-auto">
                                <div className="mb-6">
                                    <h3 className="text-2xl font-black text-gray-900 leading-tight mb-2">{lang === 'en' ? activeDrill.name_en : activeDrill.name_es}</h3>
                                    <p className="text-gray-500 text-sm">{lang === 'en' ? activeDrill.desc_en : activeDrill.desc_es}</p>
                                </div>

                                <ScoringPanel 
                                    drill={activeDrill} 
                                    score={scores[exam.id] ? (scores[exam.id][activeDrill.id] || 0) : 0}
                                    onScoreChange={(val) => updateScore(exam.id, activeDrill.id, val)}
                                    lang={lang}
                                    level={level}
                                    onClose={() => setActiveDrill(null)}
                                />
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

const App = () => {
    const [lang, setLang] = useState('es'); 
    const [user, setUser] = useState(localStorage.getItem('bu_current_user') || null);
    const [view, setView] = useState(user ? 'home' : 'login'); 
    const [selectedExam, setSelectedExam] = useState(null);
    const [allScores, setAllScores] = useState({});

    useEffect(() => {
        if (user) {
            const saved = localStorage.getItem(`bu_scores_${user}`);
            setAllScores(saved ? JSON.parse(saved) : {});
            setView('home');
        } else {
            setView('login');
        }
    }, [user]);

    const handleLogin = (username) => {
        localStorage.setItem('bu_current_user', username);
        setUser(username);
    };

    const handleLogout = () => {
        localStorage.removeItem('bu_current_user');
        setUser(null);
        setAllScores({});
        setView('login');
    };

    const updateScore = (examId, drillId, val) => {
        const newScores = {
            ...allScores,
            [examId]: {
                ...(allScores[examId] || {}),
                [drillId]: val
            }
        };
        setAllScores(newScores);
        localStorage.setItem(`bu_scores_${user}`, JSON.stringify(newScores));
    };

    const handleExamSelect = (exam) => {
        setSelectedExam(exam);
        setView('exam');
    };

    const goHome = () => {
        setSelectedExam(null);
        setView('home');
    };

    if (!user) {
        return <LoginScreen onLogin={handleLogin} lang={lang} />;
    }

    return (
        <div className="min-h-screen flex flex-col bg-gray-100 font-sans text-gray-900">
            <Header 
                lang={lang} 
                setLang={setLang} 
                goHome={goHome} 
                onProfileClick={() => setView('profile')} 
                user={user}
                onLogout={handleLogout}
            />
            
            <main className="flex-grow">
                {view === 'home' && (
                    <div className="max-w-5xl mx-auto p-6">
                        <div className="text-center mb-12 mt-8">
                            <h1 className="text-5xl font-black text-gray-900 mb-4 tracking-tight">
                                {lang === 'en' ? 'MASTER SHOT' : 'TIRO MAESTRO'}
                            </h1>
                            <p className="text-xl text-gray-500 max-w-2xl mx-auto font-light">
                                {lang === 'en' 
                                    ? 'Professional Billiard Assessment & Training Tool' 
                                    : 'Herramienta Profesional de Entrenamiento y Evaluación de Billar'}
                            </p>
                        </div>

                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-16">
                            {Object.values(examsData).map(exam => (
                                <ExamCard key={exam.id} exam={exam} lang={lang} onSelect={handleExamSelect} />
                            ))}
                        </div>

                        <div className="flex justify-center">
                            <button 
                                onClick={() => setView('glossary')}
                                className="flex items-center gap-3 text-gray-600 hover:text-blue-600 font-bold transition px-8 py-4 bg-white rounded-2xl shadow-sm border border-gray-200 hover:shadow-md hover:border-blue-200"
                            >
                                <BookOpen size={24} className="text-blue-500" />
                                {lang === 'en' ? 'Access Terminology Glossary' : 'Acceder al Glosario de Términos'}
                            </button>
                        </div>
                    </div>
                )}

                {view === 'profile' && (
                    <UserProfile user={user} scores={allScores} lang={lang} goBack={goHome} />
                )}

                {view === 'exam' && selectedExam && (
                    <ExamDetail 
                        exam={selectedExam} 
                        lang={lang} 
                        onBack={goHome} 
                        user={user}
                        scores={allScores}
                        updateScore={updateScore}
                    />
                )}

                {view === 'glossary' && (
                    <Glossary lang={lang} goBack={goHome} />
                )}
            </main>
            
            <footer className="bg-white border-t border-gray-200 p-8 text-center">
                <div className="max-w-2xl mx-auto">
                    <div className="flex justify-center items-center gap-2 mb-4 text-gray-400">
                        <GraduationCap size={24} />
                    </div>
                    <p className="text-sm text-gray-500 mb-2 font-medium">
                        &copy; 2025 Tiro Maestro (Master Shot) App
                    </p>
                    <p className="text-xs text-gray-400 leading-relaxed">
                        Based on the curriculum designed by <strong className="text-gray-600">Dr. Dave Alciatore</strong>. 
                        <br />
                        For more educational resources, please visit the official website:
                    </p>
                    <a 
                        href="https://billiarduniversity.org/" 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="inline-flex items-center gap-1 text-blue-600 hover:text-blue-800 font-bold mt-3 text-sm hover:underline"
                    >
                        billiarduniversity.org <ExternalLink size={12} />
                    </a>
                </div>
            </footer>
        </div>
    );
};

export default App;

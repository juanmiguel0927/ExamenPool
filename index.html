<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Tiro Maestro - Examen Pool</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { slate: { 850: '#1e293b' } } } }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>

    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            touch-action: manipulation; 
            margin: 0; 
            padding: 0; 
            overflow-y: auto; 
            background-color: #111827;
        }
        
        .modal-overlay { background-color: rgba(0, 0, 0, 0.95); backdrop-filter: blur(5px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.98); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-in-fade { animation: fadeIn 0.2s ease-out; }
        .animate-in-zoom { animation: zoomIn 0.2s ease-out; }

        /* Animación del Paño */
        @keyframes poolClothCycle {
            0% { background-color: #15803d; }       
            20% { background-color: #15803d; }      
            25% { background-color: #1e40af; }      
            45% { background-color: #1e40af; }      
            50% { background-color: #b91c1c; }      
            70% { background-color: #b91c1c; }      
            75% { background-color: #374151; }      
            95% { background-color: #374151; }      
            100% { background-color: #15803d; }     
        }
        .animate-bg-pool { 
            animation: poolClothCycle 20s infinite; 
            transition: background-color 2s ease-in-out; 
        }

        .pdf-scroll-container { 
            overflow: auto;
            flex: 1;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background-color: #374151;
            position: relative;
        }
        .pdf-canvas { 
            display: block; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .pool-table-frame {
            background-color: rgba(0,0,0,0.6);
            border: 20px solid #5D4037;
            border-radius: 24px;
            position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 20px 50px rgba(0,0,0,0.8);
        }
        
        .pool-table-frame::before, .pool-table-frame::after {
            content: ''; position: absolute; width: 40px; height: 40px;
            background: #1a1a1a; border-radius: 50%; border: 4px solid #3e2723; z-index: 20;
        }
        .pool-table-frame::before { top: -20px; left: -20px; }
        .pool-table-frame::after { top: -20px; right: -20px; }
        .pocket-bl { position: absolute; bottom: -20px; left: -20px; width: 40px; height: 40px; background: #1a1a1a; border-radius: 50%; border: 4px solid #3e2723; z-index: 20; }
        .pocket-br { position: absolute; bottom: -20px; right: -20px; width: 40px; height: 40px; background: #1a1a1a; border-radius: 50%; border: 4px solid #3e2723; z-index: 20; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300 text-gray-900 dark:text-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // 1. ICONOS
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Trophy = (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const Target = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>;
        const BookOpen = (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const ChevronLeft = (p) => <IconBase {...p}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRight = (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></IconBase>;
        const Check = (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const LogOut = (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></IconBase>;
        const Minus = (p) => <IconBase {...p}><line x1="5" x2="19" y1="12" y2="12"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const Clock = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const TrendingUp = (p) => <IconBase {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>;
        const Moon = (p) => <IconBase {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconBase>;
        const Sun = (p) => <IconBase {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>;
        const GraduationCap = (p) => <IconBase {...p}><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></IconBase>;
        const BarChart2 = (p) => <IconBase {...p}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></IconBase>;
        const FileText = (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>;
        const ExternalLink = (p) => <IconBase {...p}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></IconBase>;
        const Video = (p) => <IconBase {...p}><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></IconBase>;
        const ZoomIn = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></IconBase>;
        const ZoomOut = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="8" x2="14" y1="11" y2="11"/></IconBase>;
        const ChevronDown = (p) => <IconBase {...p}><path d="m6 9 6 6 6-6"/></IconBase>;
        const ChevronUp = (p) => <IconBase {...p}><path d="m18 15-6-6-6 6"/></IconBase>;
        const Edit = (p) => <IconBase {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconBase>;
        const Users = (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const Shield = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>;

        // 2. DATOS
        const PDF_RAW_URL = "https://cdn.jsdelivr.net/gh/juanmiguel0927/ExamenPool@5eae9e124ba5a7b3353ea766ce4533d87b00b94a/All.pdf";

        const getPdfViewerUrl = (page) => {
            const pageNum = page && !isNaN(page) && page > 0 ? page : 1;
            return `${PDF_RAW_URL}#page=${pageNum}&view=FitH&toolbar=0&navpanes=0`;
        };

        const BU_RATING_LEVELS = [
            { score: 0, label: "Recreativo" },
            { score: 55, label: "Principiante (D- a D+)" },
            { score: 85, label: "Intermedio (C- a C+)" },
            { score: 110, label: "Avanzado (B- a B+)" },
            { score: 140, label: "Experto (A- a A)" },
            { score: 165, label: "Semiprofesional (A+ a AA)" },
            { score: 185, label: "Profesional (AAA)" }
        ];

        // Helper Functions
        const getSafeScore = (data) => { if (typeof data === 'object' && data !== null) { return Number(data.score) || 0; } return Number(data) || 0; };
        const getSafeAttempts = (data) => { if (typeof data === 'object' && data !== null) { return Number(data.attempts) || 0; } return 0; };

        const BADGES = [
            { id: 'first_steps', name: 'Primeros Pasos', desc: 'Completar tu primer ejercicio', icon: Target, condition: (s) => Object.keys(s).length > 0 },
            { id: 'dedicated', name: 'Dedicado', desc: 'Más de 50 ejercicios completados', icon: Clock, condition: (s) => { let count = 0; Object.values(s).forEach(e => count += Object.keys(e).length); return count > 50; }},
            { id: 'sharpshooter', name: 'Francotirador', desc: 'Puntuación perfecta', icon: CheckCircle, condition: (s) => { return Object.values(s).some(exam => Object.values(exam).some(val => getSafeScore(val) >= 10)); }},
            { id: 'master_class', name: 'Maestro', desc: 'Nivel Maestro', icon: GraduationCap, condition: (s) => { let sum = 0; Object.values(s).forEach(e => Object.values(e).forEach(v => sum += getSafeScore(v))); return sum >= 300; }}
        ];

        const glossaryTerms = [
            { term: "CB", def_es: "Bola Blanca (Cue Ball)." }, { term: "OB", def_es: "Bola Objetivo (Object Ball)." }, { term: "BIH", def_es: "Bola en Mano." },
            { term: "Cut Shot", def_es: "Tiro de Corte / Fina." }, { term: "Stop Shot", def_es: "Tiro de Stop / Clavada." }, { term: "Follow Shot", def_es: "Tiro Corrido (Efecto arriba)." },
            { term: "Draw Shot", def_es: "Tiro de Retroceso (Efecto abajo)." }, { term: "Stun Shot", def_es: "Tiro Seco." }
        ];

        // --- GENERADORES DE DATOS ---
        const generateExam3Drills = () => {
            const drills = [];
            drills.push({ id: "A1", name: "Tiro A1", desc: "Práctica de tiro avanzado.", pdf_page: 51, max_score: 4, total_shots: 3, scoringType: 'weighted', subDrills: [{ id: "A1", name: "Tiro A1", max_score: 4, total_shots: 3, scoringType: 'weighted', pdf_page: 51 }] });
            for (let i = 2; i <= 25; i += 2) {
                const page = 52 + (i - 2) / 2;
                const id1 = `A${i}`;
                const id2 = `A${i+1}`;
                drills.push({ 
                    id: `${id1}-${id2}`, name: `Tiros ${id1} y ${id2}`, desc: "Práctica de tiros avanzados.", pdf_page: page, isGroup: true, 
                    subDrills: [ 
                        { id: id1, name: `Tiro ${id1}`, max_score: 4, total_shots: 3, scoringType: 'weighted', pdf_page: page }, 
                        { id: id2, name: `Tiro ${id2}`, max_score: 4, total_shots: 3, scoringType: 'weighted', pdf_page: page } 
                    ] 
                });
            }
            return drills;
        };

        const generatePPCData = () => {
            const drills = [];
            drills.push({ id: "PPC-1", name: "Ejercicio 1", desc: "Layout 1 PPC", pdf_page: 68, max_score: 100, total_shots: 100, scoringType: 'deduction', subDrills: [{ id: "PPC-1", name: "Layout 1", max_score: 100, total_shots: 100, scoringType: 'deduction', pdf_page: 68 }] });
            for (let i = 2; i <= 17; i += 2) {
                const page = 68 + (i / 2); 
                drills.push({ id: `PPC-${i}-${i+1}`, name: `Ejercicios ${i} y ${i+1}`, desc: "Layouts PPC", pdf_page: 68, isGroup: true, subDrills: [ { id: `PPC-${i}`, name: `Layout ${i}`, max_score: 100, total_shots: 100, scoringType: 'deduction', pdf_page: 68 }, { id: `PPC-${i+1}`, name: `Layout ${i+1}`, max_score: 100, total_shots: 100, scoringType: 'deduction', pdf_page: 68 } ] });
            }
            drills.push({ id: "PPC-18", name: "Ejercicio 18", desc: "Layout 18 PPC", pdf_page: 77, max_score: 100, total_shots: 100, scoringType: 'deduction', subDrills: [{ id: "PPC-18", name: "Layout 18", max_score: 100, total_shots: 100, scoringType: 'deduction', pdf_page: 77 }] });
            return drills;
        };

        const generateExam6Drills = () => {
            const drills = [];
            for (let i = 1; i <= 20; i += 2) {
                const page = 78 + Math.floor((i - 1) / 2);
                drills.push({ id: `Safe${i}-${i+1}`, name: `Defensas ${i} y ${i+1}`, desc: "Ejercicios de Seguridad", pdf_page: page, isGroup: true, subDrills: [ { id: `Safe${i}`, name: `Defensa ${i}`, max_score: 1, total_shots: 1, scoringType: 'count', pdf_page: page }, { id: `Safe${i+1}`, name: `Defensa ${i+1}`, max_score: 1, total_shots: 1, scoringType: 'count', pdf_page: page } ] });
            }
            return drills;
        };

        const examsData = {
            I: { id: "I", title: "Examen I - Fundamentos", desc: "Ejercicios progresivos.", drills: [ 
                { id: "F1", name: "Tiro de Corte", desc: "Práctica progresiva.", max_score: 10, total_shots: 10, start_score: 4, pdf_page: 1, scoringType: 'progressive' }, 
                { id: "F2", name: "Tiro de Stop", desc: "Detener CB en zona fantasma.", max_score: 10, total_shots: 10, start_score: 4, pdf_page: 2, scoringType: 'progressive' }, 
                { id: "F3", name: "Tiro Corrido", desc: "Seguir a zona objetivo.", max_score: 10, total_shots: 10, start_score: 4, pdf_page: 3, scoringType: 'progressive' }, 
                { id: "F4", name: "Tiro de Retroceso", desc: "Retroceder a zona objetivo.", max_score: 10, total_shots: 10, start_score: 4, pdf_page: 4, scoringType: 'progressive' }, 
                { id: "F5", name: "Tiro Seco", desc: "Control de stun.", max_score: 10, total_shots: 10, start_score: 1, pdf_page: 5, scoringType: 'progressive' }, 
                { id: "F6", name: "Embocar Bolas", desc: "Sin tocar bandas innecesarias.", max_score: 10, total_shots: 10, pdf_page: 6, scoringType: 'count' }, 
                { id: "F7", name: "Rueda de Carreta", desc: "Control de dirección.", max_score: 20, total_shots: 20, pdf_page: 7, scoringType: 'count' }, 
                { id: "F8", name: "Objetivo en Rejilla", desc: "Posición precisa.", max_score: 20, total_shots: 20, pdf_page: 8, scoringType: 'count' } 
            ]},
            II: { id: "II", title: "Examen II - Habilidades", desc: "Situaciones reales por nivel.", levels: ["Bachelors", "Masters", "Doctorate"], drills: [ 
                { id: "S1", name: "Línea de Bolas", max_score: {Bachelors: 4, Masters: 7, Doctorate: 10}, total_shots: {Bachelors: 2, Masters: 3, Doctorate: 4}, scoringType: 'count', pdf_page: {Bachelors: 9, Masters: 23, Doctorate: 37} }, 
                { id: "S2", name: "Corte de Banda", max_score: {Bachelors: 6, Masters: 10, Doctorate: 14}, total_shots: {Bachelors: 2, Masters: 3, Doctorate: 4}, scoringType: 'count', pdf_page: {Bachelors: 10, Masters: 24, Doctorate: 38} }, 
                { id: "S3", name: "Patrones Bola 9", max_score: 10, total_shots: 3, scoringType: 'count', has_variations: true, variations: [ { id: "S3-L1", name: "Layout 1", pdf_page: { Bachelors: 11, Masters: 25, Doctorate: 39 }, max_score: 10, total_shots: 1, scoringType: 'count' }, { id: "S3-L2", name: "Layout 2", pdf_page: { Bachelors: 12, Masters: 26, Doctorate: 40 }, max_score: 10, total_shots: 1, scoringType: 'count' }, { id: "S3-L3", name: "Layout 3", pdf_page: { Bachelors: 13, Masters: 27, Doctorate: 41 }, max_score: 10, total_shots: 1, scoringType: 'count' } ] }, 
                { id: "S4", name: "Patrones Bola 8", max_score: 10, total_shots: 3, scoringType: 'count', has_variations: true, variations: [ { id: "S4-L1", name: "Layout 1", pdf_page: { Bachelors: 14, Masters: 28, Doctorate: 42 }, max_score: 10, total_shots: 1, scoringType: 'count' }, { id: "S4-L2", name: "Layout 2", pdf_page: { Bachelors: 15, Masters: 29, Doctorate: 43 }, max_score: 10, total_shots: 1, scoringType: 'count' }, { id: "S4-L3", name: "Layout 3", pdf_page: { Bachelors: 16, Masters: 30, Doctorate: 44 }, max_score: 10, total_shots: 1, scoringType: 'count' } ] }, 
                { id: "S5", name: "Defensas", max_score: {Bachelors: 6, Masters: 10, Doctorate: 14}, total_shots: {Bachelors: 6, Masters: 10, Doctorate: 14}, scoringType: 'count', pdf_page: {Bachelors: 17, Masters: 31, Doctorate: 45} }, 
                { id: "S6", name: "Tiro de Retruque", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', pdf_page: {Bachelors: 18, Masters: 32, Doctorate: 46} }, 
                { id: "S7", name: "Tiro de Banda", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', pdf_page: {Bachelors: 19, Masters: 33, Doctorate: 47} }, 
                { id: "S8", name: "Tiro Elevado", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', pdf_page: {Bachelors: 20, Masters: 34, Doctorate: 48} }, 
                { id: "S9", name: "Salto o Massé", max_score: {Bachelors: 3, Masters: 5, Doctorate: 7}, total_shots: {Bachelors: 3, Masters: 5, Doctorate: 7}, scoringType: 'count', pdf_page: {Bachelors: 21, Masters: 35, Doctorate: 49} }, 
                { id: "S10", name: "Saque", max_score: 5, total_shots: 3, scoringType: 'count', pdf_page: {Bachelors: 22, Masters: 36, Doctorate: 50} } ] },
            III: { id: "III", title: "Examen III - Tiros Avanzados", desc: "25 tiros específicos.", drills: generateExam3Drills() },
            IV: { id: "IV", title: "RDS - Sistema de Limpieza", desc: "16 Niveles.", drills: Array.from({length: 16}, (_, i) => { let page = 65; if (i >= 6 && i <= 11) page = 66; if (i >= 12) page = 67; return { id: `L${i+1}`, name: `Nivel ${i+1}`, max_score: 100, total_shots: 1, scoringType: 'count', pdf_page: page }; }) },
            V: { id: "V", title: "PPC - Desafío de Colocación", desc: "18 Layouts (1-18).", drills: generatePPCData() },
            VI: { id: "VI", title: "Desafío de Seguridad", desc: "20 Tiros defensivos.", drills: generateExam6Drills() }
        };

        // --- 4. COMPONENTES AUXILIARES ---
        const SessionTimer = () => {
            const [seconds, setSeconds] = useState(0);
            useEffect(() => { const interval = setInterval(() => setSeconds(s => s + 1), 1000); return () => clearInterval(interval); }, []);
            const format = (s) => { const m = Math.floor(s/60); const sc = s%60; return `${m}:${sc<10?'0':''}${sc}`; };
            return <div className="hidden md:flex items-center gap-2 bg-gray-800 px-3 py-1 rounded text-sm font-mono text-gray-300 ml-4"><Clock size={14} /> {format(seconds)}</div>;
        };

        const ActionButtons = ({ onHit, onMiss, hitDisabled, missDisabled }) => (
            <div className="flex gap-6 w-full max-w-md mb-8">
                <button onClick={onMiss} disabled={missDisabled} className="flex-1 bg-red-500 hover:bg-red-600 disabled:bg-gray-200 dark:disabled:bg-gray-700 disabled:text-gray-400 disabled:cursor-not-allowed text-white font-black text-2xl py-8 rounded-2xl shadow-xl shadow-red-100 dark:shadow-none transform transition active:scale-95 flex flex-col items-center justify-center gap-2"><X size={32} strokeWidth={4} /><span className="text-xs uppercase font-bold opacity-80">Fallo</span></button>
                <button onClick={onHit} disabled={hitDisabled} className="flex-1 bg-green-500 hover:bg-green-600 disabled:bg-gray-200 dark:disabled:bg-gray-700 disabled:text-gray-400 disabled:cursor-not-allowed text-white font-black text-2xl py-8 rounded-2xl shadow-xl shadow-green-100 dark:shadow-none transform transition active:scale-95 flex flex-col items-center justify-center gap-2"><Check size={32} strokeWidth={4} /><span className="text-xs uppercase font-bold opacity-80">Acierto</span></button>
            </div>
        );

        const PdfViewer = ({ page }) => {
            const canvasRef = useRef(null);
            const [scale, setScale] = useState(1.0); 

            useEffect(() => {
                const renderPdf = async () => {
                    if (!window.pdfjsLib) return;
                    try {
                        const loadingTask = pdfjsLib.getDocument(PDF_RAW_URL);
                        const pdf = await loadingTask.promise;
                        const pageData = await pdf.getPage(page);
                        const viewport = pageData.getViewport({ scale: scale }); 
                        const canvas = canvasRef.current;
                        if (!canvas) return;
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        
                        await pageData.render({ canvasContext: context, viewport }).promise;
                    } catch (e) { console.error("Error al renderizar la página PDF:", e); }
                };
                renderPdf();
            }, [page, scale]);

            return (
                <div className="flex flex-col h-full bg-gray-100 dark:bg-gray-800 relative">
                     {/* ZOOM MOVED TO BOTTOM RIGHT */}
                     <div className="absolute bottom-4 right-4 flex gap-2 z-20">
                        <button onClick={() => setScale(s => Math.max(0.5, s - 0.25))} className="p-2 bg-white dark:bg-gray-900 rounded-full shadow-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300"><ZoomOut size={20} /></button>
                        <button onClick={() => setScale(s => Math.min(3.0, s + 0.25))} className="p-2 bg-white dark:bg-gray-900 rounded-full shadow-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300"><ZoomIn size={20} /></button>
                    </div>
                    <div className="pdf-scroll-container">
                        <canvas ref={canvasRef} className="pdf-canvas" />
                    </div>
                </div>
            );
        };

        const ZoomableChart = ({ data }) => {
            const [zoomLevel, setZoomLevel] = useState(1);
            if (!data || data.length < 2) return <div className="text-center text-gray-400 dark:text-gray-500 text-sm py-8">Practica más días para ver tu progreso</div>;
            const containerWidth = 400 * zoomLevel;
            const height = 150; 
            const padding = 20;
            const maxScore = Math.max(...data.map(d => d.score), 100);
            const points = data.map((d, i) => {
                const x = padding + (i / (data.length - 1)) * (containerWidth - 2 * padding);
                const y = height - padding - (d.score / maxScore) * (height - 2 * padding);
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="flex flex-col items-end">
                    <div className="flex gap-2 mb-2">
                        <button onClick={() => setZoomLevel(Math.min(3, zoomLevel + 0.5))} className="p-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600"><Plus size={16}/></button>
                        <button onClick={() => setZoomLevel(Math.max(1, zoomLevel - 0.5))} className="p-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600"><Minus size={16}/></button>
                    </div>
                    <div className="w-full overflow-x-auto no-scrollbar">
                        <div style={{ width: `${zoomLevel * 100}%`, minWidth: '100%' }}>
                            <svg viewBox={`0 0 ${containerWidth} ${height}`} className="w-full h-auto">
                                <polyline fill="none" stroke="#22c55e" strokeWidth="3" points={points} />
                                {data.map((d, i) => {
                                     const x = padding + (i / (data.length - 1)) * (containerWidth - 2 * padding);
                                     const y = height - padding - (d.score / maxScore) * (height - 2 * padding);
                                     return <circle key={i} cx={x} cy={y} r="4" fill="#fff" stroke="#22c55e" strokeWidth="2" />
                                })}
                            </svg>
                        </div>
                    </div>
                    <div className="w-full flex justify-between text-xs text-gray-400 mt-2"><span>Inicio</span><span>Actual</span></div>
                </div>
            );
        };

        // --- 5. PANELES DE PUNTUACIÓN ---
        const UnifiedScoringPanel = ({ drill, savedData, onUpdateData, onClose, onNext, isLast, level, onReset, notes, onSaveNote }) => {
            // Determine default start score based on drill type
            const defaultStartScore = (drill.start_score !== undefined) ? drill.start_score : 0;

            // Logic to force correct start positions if data is missing or invalid
            const getInitialPosition = () => {
                // If we have saved data
                if (savedData && savedData.attempts > 0) {
                    // If it's progressive (F1-F5) and saved score is 0 (invalid), force reset
                    if (drill.scoringType === 'progressive' && Number(savedData.score) === 0) {
                         return defaultStartScore;
                    }
                    return Number(savedData.score);
                }
                // If new or invalid data
                if (drill.scoringType === 'progressive') return defaultStartScore;
                if (drill.scoringType === 'deduction') return 100;
                return 0;
            };

            const [attempts, setAttempts] = useState(savedData ? (Number(savedData.attempts) || 0) : 0);
            const [position, setPosition] = useState(getInitialPosition);
            
            const [noteText, setNoteText] = useState(notes || "");
            const [showNotes, setShowNotes] = useState(false);
            const [isEditingAttempts, setIsEditingAttempts] = useState(false);
            const [customLimit, setCustomLimit] = useState(null);

            let totalShotsLimit = customLimit || 10;

            if (!customLimit) {
                if (typeof drill.total_shots === 'object') totalShotsLimit = drill.total_shots[level] || 10;
                else if (drill.total_shots) totalShotsLimit = drill.total_shots;
                
                if (drill.scoringType === 'weighted') totalShotsLimit = 3;
                if (drill.scoringType === 'deduction') totalShotsLimit = 100; 
            }
            
            // Force persistence of corrected state on mount if needed
            useEffect(() => {
                if (drill.scoringType === 'progressive' && (!savedData || Number(savedData.score) === 0)) {
                     onUpdateData(defaultStartScore, attempts);
                }
            }, []);


            const handleHit = () => {
                let newAttempts = attempts + 1;
                let newScore = position;

                if (drill.scoringType === 'progressive') {
                    if (newScore < 7) newScore = newScore + 1;
                } else {
                    if (drill.scoringType !== 'deduction') newScore = newScore + 1;
                }
                
                setAttempts(newAttempts);
                setPosition(newScore);
                onUpdateData(newScore, newAttempts); 
            };

            const handleMiss = () => {
                let newAttempts = attempts + 1;
                let newScore = position;

                if (drill.scoringType === 'progressive') {
                     if (newScore > 1) newScore = newScore - 1;
                } else if (drill.scoringType === 'deduction') {
                     newScore = newScore - 1;
                }
                
                setAttempts(newAttempts);
                setPosition(newScore);
                onUpdateData(newScore, newAttempts);
            };

            const handleLocalReset = () => {
                let resetScore = 0;
                if (drill.scoringType === 'progressive') resetScore = drill.start_score || 4;
                if (drill.scoringType === 'deduction') resetScore = 100;
                
                setAttempts(0);
                setPosition(resetScore);
                onUpdateData(resetScore, 0);
            };

            const handleSaveNote = () => { onSaveNote(noteText); setShowNotes(false); };

            let statusText = "Aciertos";
            if(drill.scoringType === 'progressive') statusText = "Nivel / Posición";
            if(drill.scoringType === 'weighted') statusText = "Puntos Obtenidos";
            if(drill.scoringType === 'deduction') statusText = "Puntos Restantes";

            let positionIndicator = null;
            if (drill.scoringType === 'progressive') {
                positionIndicator = (
                    <div className="bg-yellow-500 text-black border-4 border-yellow-600 rounded-xl p-4 mb-6 w-full max-w-md text-center shadow-lg">
                         <p className="text-xs font-bold uppercase tracking-wide opacity-80">Próximo Tiro</p>
                         <p className="text-3xl font-black mt-1">DESDE POSICIÓN {position}</p>
                    </div>
                );
            }

            let buttonsDisabled = false;
            if (attempts >= totalShotsLimit) buttonsDisabled = true;

            return (
                <div className="flex flex-col h-full p-8 items-center justify-between relative">
                    <button onClick={handleLocalReset} className="absolute top-0 left-0 text-gray-400 hover:text-red-500 flex items-center gap-1 text-xs uppercase font-bold transition p-2"><RotateCcw size={16} /> Reiniciar</button>
                    <div className="text-center w-full mt-4 flex flex-col items-center">
                        <div className="inline-block px-3 py-1 bg-blue-500/20 text-blue-400 rounded-full text-xs font-bold mb-6 tracking-wide uppercase">{drill.id} - {drill.name}</div>
                        
                        {positionIndicator}

                        <div className="text-7xl font-black text-white mb-2 tracking-tighter leading-none">
                            {attempts} 
                             <span className="text-4xl text-gray-600 font-medium flex items-center justify-center gap-2">
                                    / {isEditingAttempts ? <input type="number" className="w-16 bg-transparent border-b border-gray-400 text-center focus:outline-none text-white" value={totalShotsLimit} onChange={(e) => setCustomLimit(Number(e.target.value))} onBlur={() => setIsEditingAttempts(false)} autoFocus /> : totalShotsLimit}
                                    <button onClick={() => setIsEditingAttempts(true)} className="text-gray-600 hover:text-blue-500"><Edit size={16}/></button>
                            </span>
                        </div>
                        <div className="text-sm font-bold text-gray-500 uppercase tracking-widest mb-8">{statusText}: {position}</div>
                    </div>
                    <div className="relative z-10 w-full flex justify-center"><ActionButtons onHit={handleHit} onMiss={handleMiss} hitDisabled={buttonsDisabled} missDisabled={buttonsDisabled} /></div>
                    
                    <div className="w-full flex gap-3 relative z-10 mt-auto">
                        <button onClick={onClose} className="flex-1 bg-gray-800 border border-gray-700 text-gray-400 font-bold py-4 rounded-xl shadow-sm transition uppercase tracking-widest text-xs hover:bg-gray-700">Cancelar</button>
                        <button onClick={onNext} className="flex-[2] bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition uppercase tracking-widest text-xs flex items-center justify-center gap-2">
                             {isLast ? "Guardar y Salir" : "Guardar y Siguiente"} {!isLast && <ChevronRight size={16} />}
                        </button>
                    </div>
                </div>
            );
        };

        const MiniScoringPanel = ({ drill, savedData, onUpdateData }) => {
            const initialScore = savedData && savedData.score !== undefined ? Number(savedData.score) : 0;
            const initialAttempts = savedData && savedData.attempts !== undefined ? Number(savedData.attempts) : 0;

            const [localAttempts, setLocalAttempts] = useState(initialAttempts);
            const [currentScore, setCurrentScore] = useState(initialScore);
            
            const [isEditingAttempts, setIsEditingAttempts] = useState(false);
            const [customLimit, setCustomLimit] = useState(null);

            let totalShots = customLimit || 10;
            if (!customLimit) {
                if (drill.total_shots) totalShots = drill.total_shots;
                if (drill.scoringType === 'weighted') totalShots = 3;
                if (drill.scoringType === 'deduction') totalShots = 100;
            }

             useEffect(() => { 
                 if (drill.scoringType === 'deduction' && initialAttempts === 0 && initialScore === 0) { 
                    setCurrentScore(100);
                    onUpdateData(100, 0);
                 } else {
                    setLocalAttempts(initialAttempts);
                    setCurrentScore(initialScore);
                 }
            }, [drill.id, initialScore, initialAttempts]);

            const handleHit = () => {
                 let newAttempts = localAttempts + 1;
                 let newScore = currentScore;
                 
                 if (drill.scoringType !== 'deduction') { 
                     newScore = currentScore + 1;
                 }
                 setLocalAttempts(newAttempts);
                 setCurrentScore(newScore);
                 onUpdateData(newScore, newAttempts);
            };
            const handleMiss = () => {
                 let newAttempts = localAttempts + 1;
                 let newScore = currentScore;
                 
                 if (drill.scoringType === 'deduction') {
                     newScore = newScore - 1;
                 }
                 setLocalAttempts(newAttempts);
                 setCurrentScore(newScore);
                 onUpdateData(newScore, newAttempts);
            };
            const handleReset = () => { 
                let resetVal = (drill.scoringType === 'deduction') ? 100 : 0;
                setLocalAttempts(0);
                setCurrentScore(resetVal);
                onUpdateData(resetVal, 0); 
            };
            
            let buttonsDisabled = localAttempts >= totalShots;

            return (
                <div className="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm relative mb-4">
                    <button onClick={handleReset} className="absolute top-2 left-2 text-gray-400 hover:text-red-500 p-1"><RotateCcw size={14}/></button>
                    <div className="flex justify-between items-center mb-3 pl-8"><div><h4 className="font-bold text-gray-800 dark:text-gray-200">{drill.name}</h4></div><div className="text-xl font-black">{currentScore}</div></div>
                    <div className="flex gap-2 mb-2"><button onClick={handleMiss} disabled={buttonsDisabled} className="flex-1 bg-red-500 text-white py-3 rounded-lg font-bold text-xs shadow disabled:opacity-50 disabled:bg-gray-400">Fallo</button><button onClick={handleHit} disabled={buttonsDisabled} className="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold text-xs shadow disabled:opacity-50 disabled:bg-gray-400">Acierto</button></div>
                    
                    <div className="text-xs text-center mt-1 text-gray-500 flex items-center justify-center gap-1">
                        Intentos: {localAttempts} / 
                        {isEditingAttempts ? <input type="number" className="w-8 bg-transparent border-b border-gray-400 text-center text-xs focus:outline-none" value={totalShots} onChange={(e) => setCustomLimit(Number(e.target.value))} onBlur={() => setIsEditingAttempts(false)} autoFocus /> : totalShots}
                        <button onClick={() => setIsEditingAttempts(true)} className="text-gray-400 hover:text-blue-500"><Edit size={10}/></button>
                    </div>
                </div>
            );
        }

        // --- 6. MODAL Y VISTAS ---
        const PracticeModalFinal = ({ drill, fullData, onUpdateScore, onClose, onNextDrill, isLastDrill, level, examId, notes, saveNote }) => {
            let pdfPage = drill.pdf_page;
            if (typeof pdfPage === 'object' && pdfPage !== null) { pdfPage = pdfPage[level] || pdfPage['Bachelors']; }
            const isMultiDrill = drill.isGroup && drill.subDrills;
            const currentData = fullData[drill.id] || {score: 0, attempts: 0};

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-0 md:p-4 modal-overlay animate-in-fade">
                    <div className="bg-slate-900 w-full h-full md:h-[95vh] md:rounded-3xl md:shadow-2xl flex flex-col md:flex-row relative animate-in-zoom border border-slate-700 overflow-hidden">
                        <div className="w-full h-1/2 md:h-full md:w-7/12 bg-slate-800 relative flex flex-col border-b md:border-b-0 md:border-r border-slate-700">
                             <div className="absolute top-4 right-4 z-50 md:hidden"><button onClick={onClose} className="bg-black/50 text-white p-2 rounded-full backdrop-blur-sm"><X size={24} /></button></div>
                             <PdfViewer page={pdfPage} />
                        </div>
                        <div className="w-full h-1/2 md:h-full md:w-5/12 bg-slate-900 flex flex-col relative z-20 overflow-y-auto">
                            <div className="absolute top-4 right-4 hidden md:block z-50"><button onClick={onClose} className="text-gray-400 hover:text-white p-2 rounded-full hover:bg-slate-800 transition"><X size={24} /></button></div>
                            {isMultiDrill ? (
                                <div className="p-6 flex flex-col h-full">
                                    <div className="mb-6 text-center"><h2 className="text-2xl font-black text-white mb-1">{drill.name}</h2><p className="text-sm text-gray-500">{drill.desc}</p></div>
                                    <div className="flex-grow overflow-y-auto space-y-3 pr-2 mb-4 custom-scrollbar">
                                        {drill.subDrills.map(subDrill => (
                                            <MiniScoringPanel key={subDrill.id} drill={subDrill} savedData={fullData[subDrill.id]} onUpdateData={(s, a) => onUpdateScore(subDrill.id, s, a)} />
                                        ))}
                                    </div>
                                    <button onClick={onNextDrill} className="w-full mt-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg uppercase text-sm flex justify-center gap-2">{isLastDrill ? "Guardar y Salir" : "Siguiente Página"} {!isLastDrill && <ChevronRight size={18} />}</button>
                                </div>
                            ) : (
                                <UnifiedScoringPanel key={drill.id} drill={drill} savedData={currentData} onUpdateData={(s, a) => onUpdateScore(drill.id, s, a)} onClose={onClose} onNext={onNextDrill} isLast={isLastDrill} level={level} onClose={onClose} note={notes[`${examId}-${drill.id}`]} onSaveNote={(txt) => saveNote(examId, drill.id, txt)} />
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const VariationsModal = ({ drill, onClose, onSelectVariation }) => (
             <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-in-fade">
                <div className="bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col p-6 relative animate-in-zoom border border-slate-700">
                     <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white"><X size={24} /></button>
                     <h3 className="text-xl font-black text-white mb-4 text-center">{drill.name}</h3>
                     <p className="text-gray-400 text-center mb-6 text-sm">{drill.desc_es}</p>
                     <div className="flex flex-col gap-3">
                         {drill.variations.map(v => (
                             <button key={v.id} onClick={() => onSelectVariation(v)} className="p-4 bg-slate-700 hover:bg-slate-600 border border-slate-600 hover:border-blue-500 rounded-xl text-left transition group">
                                 <span className="font-bold text-white group-hover:text-blue-400 block">{v.name}</span>
                                 <span className="text-xs text-gray-400 uppercase font-bold tracking-wider">ID: {v.id}</span>
                             </button>
                         ))}
                     </div>
                </div>
             </div>
        );

        const ExamCard = ({ exam, onSelect }) => (
            <div onClick={() => onSelect(exam)} className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 hover:shadow-xl hover:border-green-500 hover:-translate-y-1 transition-all duration-300 cursor-pointer group relative overflow-hidden"><div className="absolute top-0 right-0 bg-gradient-to-br from-gray-50 to-gray-100 w-24 h-24 rounded-bl-full -mr-10 -mt-10 transition-colors group-hover:from-green-50 group-hover:to-green-100"></div><div className="flex items-center gap-4 mb-4 relative z-10"><div className="p-3 bg-gray-100 rounded-xl group-hover:bg-green-600 group-hover:text-white transition-colors duration-300 text-gray-700 shadow-sm">{exam.id === 'I' && <RotateCcw size={28} />}{exam.id === 'II' && <Shield size={28} />}{exam.id === 'III' && <Trophy size={28} />}{['IV', 'V', 'VI'].includes(exam.id) && <BookOpen size={28} />}</div><h2 className="text-xl font-bold text-gray-800 group-hover:text-green-700 transition-colors">{exam.title}</h2></div><p className="text-gray-500 text-sm mb-6 leading-relaxed relative z-10">{exam.desc}</p><div className="text-green-600 text-sm font-bold flex items-center gap-2 group-hover:translate-x-2 transition-transform">Iniciar Evaluación <ChevronLeft className="rotate-180 w-4 h-4" /></div></div>
        );

        const UserProfile = ({ user, scores, goBack, onExport, onImport, history, onDrillSelect }) => {
            const scoreI = Object.values(scores['I'] || {}).reduce((a, b) => a + getSafeScore(b), 0);
            const scoreII = Object.values(scores['II'] || {}).reduce((a, b) => a + getSafeScore(b), 0);
            const buTotal = scoreI + scoreII;
            const buLevel = BU_RATING_LEVELS.slice().reverse().find(l => buTotal >= l.score) || BU_RATING_LEVELS[0];
            const badges = BADGES.filter(b => b.condition(scores));
            const fileInputRef = React.useRef();
            const [openSections, setOpenSections] = useState({});
            const toggleSection = (key) => setOpenSections(prev => ({ ...prev, [key]: !prev[key] }));

            const [isEditingName, setIsEditingName] = useState(false);
            const [newName, setNewName] = useState(user);

            const handleNameChange = () => {
                if (newName.trim() && newName !== user) {
                    const savedScores = localStorage.getItem(`bu_scores_${user}`);
                    const savedNotes = localStorage.getItem(`bu_notes_${user}`);
                    const savedHistory = localStorage.getItem(`bu_history_${user}`);
                    const usersList = JSON.parse(localStorage.getItem('bu_users_list') || '[]');
                    
                    localStorage.setItem(`bu_scores_${newName}`, savedScores || '{}');
                    localStorage.setItem(`bu_notes_${newName}`, savedNotes || '{}');
                    localStorage.setItem(`bu_history_${newName}`, savedHistory || '[]');
                    
                    const newUsersList = usersList.map(u => u === user ? newName : u);
                    localStorage.setItem('bu_users_list', JSON.stringify(newUsersList));
                    localStorage.setItem('bu_current_user', newName);
                    
                    // Cleanup old user
                    localStorage.removeItem(`bu_scores_${user}`);
                    localStorage.removeItem(`bu_notes_${user}`);
                    localStorage.removeItem(`bu_history_${user}`);
                    
                    window.location.reload(); // Simple reload to refresh context
                }
                setIsEditingName(false);
            };

            const renderDetailTable = (examKey) => {
                const exam = examsData[examKey];
                if(!exam) return null;
                const isOpen = openSections[examKey];
                let flatDrills = [];
                if (exam.drills) {
                    exam.drills.forEach(d => {
                        if (d.isGroup || d.has_variations) {
                             const subs = d.subDrills || d.variations || [];
                             subs.forEach(sd => flatDrills.push({...sd, parentName: d.name, pdf_page: d.pdf_page || sd.pdf_page }));
                        } else {
                            flatDrills.push(d);
                        }
                    });
                }
                return (
                    <div key={examKey} className="mb-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div onClick={() => toggleSection(examKey)} className="p-4 flex justify-between items-center cursor-pointer bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition"><h5 className="font-bold text-gray-700 dark:text-gray-300">{exam.title}</h5><button className="text-gray-500">{isOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}</button></div>
                        {isOpen && (
                            <div className="overflow-x-auto p-4 border-t border-gray-200 dark:border-gray-700">
                                <table className="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                    <thead className="text-xs text-gray-700 uppercase bg-gray-100 dark:bg-gray-700 dark:text-gray-400"><tr><th className="px-4 py-2 rounded-l-lg">Ejercicio</th><th className="px-4 py-2 text-center">Puntos</th><th className="px-4 py-2 text-center">Aciertos</th><th className="px-4 py-2 text-center">Fallos (Est.)</th><th className="px-4 py-2 rounded-r-lg text-center">Estado</th></tr></thead>
                                    <tbody>
                                        {flatDrills.map(drill => {
                                            const data = scores[examKey] ? (scores[examKey][drill.id] || {score: 0, attempts: 0}) : {score: 0, attempts: 0};
                                            const scoreVal = getSafeScore(data);
                                            const attemptsVal = getSafeAttempts(data);
                                            const max = drill.max_score || 10;
                                            const percent = (scoreVal / max) * 100;
                                            const misses = attemptsVal > 0 ? attemptsVal - scoreVal : '-';
                                            let statusColor = "bg-gray-100 text-gray-800"; let statusText = "Sin Intentar";
                                            if (attemptsVal > 0) { if (percent === 100) { statusColor = "bg-green-100 text-green-800"; statusText = "Perfecto"; } else if (percent >= 80) { statusColor = "bg-blue-100 text-blue-800"; statusText = "Maestro"; } else if (percent >= 50) { statusColor = "bg-yellow-100 text-yellow-800"; statusText = "Avanzado"; } else { statusColor = "bg-red-100 text-red-800"; statusText = "Aprendiz"; } }
                                            return (<tr key={drill.id} onClick={() => onDrillSelect(exam, drill)} className="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer"><td className="px-4 py-2 font-medium text-gray-900 dark:text-white underline">{drill.id}</td><td className="px-4 py-2 text-center font-bold">{scoreVal}</td><td className="px-4 py-2 text-center">{scoreVal}</td><td className="px-4 py-2 text-center text-red-400">{misses}</td><td className="px-4 py-2 text-center"><span className={`${statusColor} text-xs font-medium px-2.5 py-0.5 rounded`}>{statusText}</span></td></tr>);
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                );
            };
            return (<div className="max-w-4xl mx-auto p-4"><button onClick={goBack} className="flex items-center text-gray-500 hover:text-gray-800 dark:hover:text-white mb-6"><ChevronLeft size={20} /> Volver</button><div className="bg-white dark:bg-gray-800 rounded-2xl shadow-md border border-gray-200 dark:border-gray-700 mb-6 p-8 flex flex-col md:flex-row items-center gap-6"><div className="w-24 h-24 rounded-full bg-green-500 flex items-center justify-center text-4xl font-bold border-4 border-white dark:border-gray-700 shadow-lg text-white">{user.charAt(0).toUpperCase()}</div><div className="text-center md:text-left flex-1">
                {isEditingName ? (
                    <div className="flex items-center gap-2">
                        <input className="text-2xl font-bold p-1 border rounded dark:bg-gray-700 dark:text-white" value={newName} onChange={(e)=>setNewName(e.target.value)} autoFocus />
                        <button onClick={handleNameChange} className="p-2 bg-green-500 text-white rounded"><Check size={20}/></button>
                    </div>
                ) : (
                    <h2 className="text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-2">{user} <button onClick={()=>setIsEditingName(true)} className="text-gray-400 hover:text-blue-500"><Edit size={18}/></button></h2>
                )}
                
                <p className="text-lg text-gray-500">Nivel: <span className="font-bold text-blue-600 dark:text-blue-400">{buLevel.label}</span></p></div><div className="flex gap-2"><button onClick={onExport} className="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 px-3 py-2 rounded text-sm font-bold hover:bg-gray-200 dark:hover:bg-gray-600 dark:text-white"><Download size={14}/> Exportar</button><button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 px-3 py-2 rounded text-sm font-bold hover:bg-gray-200 dark:hover:bg-gray-600 dark:text-white"><Upload size={14}/> Importar</button><input type="file" ref={fileInputRef} onChange={onImport} className="hidden" accept=".json" /></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><div className="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm"><h4 className="font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2"><Trophy className="text-yellow-500" size={18}/> Puntuaciones Actuales</h4><div className="space-y-3"><div className="flex justify-between text-sm border-b border-gray-100 dark:border-gray-700 pb-2 dark:text-gray-300"><span>Examen I</span><b>{scoreI}/100</b></div><div className="flex justify-between text-sm border-b border-gray-100 dark:border-gray-700 pb-2 dark:text-gray-300"><span>Examen II</span><b>{scoreII}/100</b></div><div className="flex justify-between text-sm pt-1 dark:text-white"><span className="font-bold">Total BU</span><span className="font-black text-green-600 dark:text-green-400 text-lg">{buTotal}</span></div></div></div><div className="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm"><h4 className="font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2"><TrendingUp className="text-blue-500" size={18}/> Progreso Histórico</h4><ZoomableChart data={history} /></div></div><div className="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm mb-6"><div className="flex items-center justify-between mb-4"><h4 className="font-bold text-gray-800 dark:text-white flex items-center gap-2"><BarChart2 className="text-indigo-500" size={18}/> Detalle de Rendimiento</h4></div>{Object.keys(examsData).map(key => renderDetailTable(key))}</div><div className="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm"><h4 className="font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2"><Target className="text-purple-500" size={18}/> Medallas y Logros</h4><div className="flex flex-wrap gap-4">{badges.length > 0 ? badges.map(b => (<div key={b.id} className="flex items-center gap-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 px-3 py-2 rounded-lg"><b.icon className="text-yellow-600 dark:text-yellow-400" size={20} /><div><p className="text-sm font-bold text-yellow-800 dark:text-yellow-200">{b.name}</p><p className="text-[10px] text-yellow-600 dark:text-yellow-400">{b.desc}</p></div></div>)) : <p className="text-sm text-gray-400 italic">Completa ejercicios para ganar medallas.</p>}</div></div></div>);
        };

        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState("");
            const [usersList, setUsersList] = useState(() => { const saved = localStorage.getItem('bu_users_list'); return saved ? JSON.parse(saved) : []; });
            const [isCreating, setIsCreating] = useState(usersList.length === 0);
            const [showUserModal, setShowUserModal] = useState(false); // Estado para el modal de usuarios
            
            const handleCreate = (e) => { 
                e.preventDefault(); 
                if(!username.trim()) return; 
                const name = username.trim(); 
                if (!usersList.includes(name)) { 
                    const newList = [...usersList, name]; 
                    setUsersList(newList); 
                    localStorage.setItem('bu_users_list', JSON.stringify(newList)); 
                } 
                onLogin(name); 
            };
            
            const handleImport = (event) => { 
                const file = event.target.files[0]; 
                if (!file) return; 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    try { 
                        const data = JSON.parse(e.target.result); 
                        const u = data.user;
                        if (confirm(`Importar perfil de ${u}?`)) { 
                            localStorage.setItem(`bu_scores_${u}`, JSON.stringify(data.scores || {})); 
                            localStorage.setItem(`bu_notes_${u}`, JSON.stringify(data.notes || {})); 
                            localStorage.setItem(`bu_history_${u}`, JSON.stringify(data.history || [])); 
                            
                            if (!usersList.includes(u)) {
                                const newList = [...usersList, u];
                                setUsersList(newList);
                                localStorage.setItem('bu_users_list', JSON.stringify(newList));
                            }
                            onLogin(u);
                        } 
                    } catch (err) { alert("Error al importar."); } 
                }; 
                reader.readAsText(file); 
            };

            const handleDelete = (name) => { 
                if(confirm(`¿Borrar a ${name}?`)) { 
                    const newList = usersList.filter(u => u !== name); 
                    setUsersList(newList); 
                    localStorage.setItem('bu_users_list', JSON.stringify(newList)); 
                    localStorage.removeItem(`bu_scores_${name}`); 
                    localStorage.removeItem(`bu_history_${name}`); 
                    if(usersList.length === 0) {
                        setIsCreating(true); 
                        setShowUserModal(false);
                    }
                } 
            };
            const fileInputRef = useRef(null);

            return (<div className="min-h-screen flex flex-col items-center justify-center bg-slate-900 px-4 relative overflow-hidden animate-in-fade">
                <div className="max-w-2xl w-full relative z-10">
                    <div className="text-center mb-10">
                        <h1 className="text-5xl font-black text-white mb-1 tracking-tight uppercase">TIRO MAESTRO</h1>
                        <p className="text-gray-400 uppercase tracking-widest text-sm">Examen Pool</p>
                    </div>
                    
                    {!isCreating ? (
                         <div className="grid grid-cols-2 gap-4">
                             {/* Opción 1: Nuevo Perfil (Amarilla) */}
                             <button onClick={() => setIsCreating(true)} className="bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-2xl p-6 flex flex-col items-center gap-3 transition group">
                                <div className="w-12 h-12 rounded-full bg-yellow-500 text-black font-bold flex items-center justify-center text-xl shadow-lg group-hover:scale-110 transition">1</div>
                                <span className="text-white font-bold text-sm uppercase tracking-wide">Nuevo Perfil</span>
                             </button>

                             {/* Opción 2: Cargar Perfil (Azul) - MODIFICADO PARA ABRIR MODAL */}
                             {usersList.length > 0 && (
                                 <button onClick={() => setShowUserModal(true)} className="bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-2xl p-6 flex flex-col items-center gap-3 transition group">
                                     <div className="w-12 h-12 rounded-full bg-blue-600 text-white font-bold flex items-center justify-center text-xl shadow-lg group-hover:scale-110 transition">2</div>
                                     <span className="text-white font-bold text-sm uppercase tracking-wide">Cargar Perfil</span>
                                 </button>
                             )}

                             {/* Opción 3: Importar (Roja) */}
                             <button onClick={() => fileInputRef.current.click()} className="bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-2xl p-6 flex flex-col items-center gap-3 transition group">
                                <div className="w-12 h-12 rounded-full bg-red-600 text-white font-bold flex items-center justify-center text-xl shadow-lg group-hover:scale-110 transition">3</div>
                                <span className="text-white font-bold text-sm uppercase tracking-wide">Importar</span>
                                <input type="file" ref={fileInputRef} onChange={handleImport} className="hidden" accept=".json" />
                             </button>

                             {/* Opción 8: Invitado (Negra) */}
                             <button onClick={() => onLogin("Invitado")} className="bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-2xl p-6 flex flex-col items-center gap-3 transition group">
                                <div className="w-12 h-12 rounded-full bg-black border border-gray-600 text-white font-bold flex items-center justify-center text-xl shadow-lg group-hover:scale-110 transition">8</div>
                                <span className="text-white font-bold text-sm uppercase tracking-wide">Invitado</span>
                             </button>
                         </div>
                    ) : (
                        <div className="max-w-md mx-auto bg-slate-800 p-8 rounded-2xl shadow-2xl relative border border-slate-700">
                             <button onClick={() => setIsCreating(false)} className="absolute top-4 left-4 text-gray-400 hover:text-white"><ChevronLeft size={24} /></button>
                             <h3 className="text-2xl font-bold text-white mb-6 text-center">CREAR PERFIL</h3>
                             <form onSubmit={handleCreate}>
                                <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="Nombre del Jugador" className="w-full p-4 bg-slate-900 border border-slate-700 rounded-xl mb-4 text-center text-lg text-white outline-none focus:border-blue-500 transition font-bold" autoFocus />
                                <button type="submit" disabled={!username.trim()} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl transition disabled:opacity-50 uppercase tracking-wider shadow-lg">COMENZAR</button>
                             </form>
                        </div>
                    )}

                    {!isCreating && (
                        <div className="mt-12">
                            {/* MODIFICADO: Botón convertido en enlace */}
                            <a href="https://juanmiguel0927.github.io/Pool/" target="_self" className="block w-full bg-red-600 hover:bg-red-700 text-white font-black py-4 rounded-xl shadow-lg uppercase tracking-widest transition transform hover:scale-105 text-center no-underline">
                                TIRO MAESTRO (PLAN DE ENTRENAMIENTO)
                            </a>
                        </div>
                    )}
                </div>

                {/* MODAL DE SELECCIÓN Y BORRADO DE USUARIOS */}
                {showUserModal && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-in-fade">
                        <div className="bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl p-6 relative animate-in-zoom border border-slate-700 flex flex-col max-h-[80vh]">
                            <button onClick={() => setShowUserModal(false)} className="absolute top-4 right-4 text-gray-400 hover:text-white"><X size={24} /></button>
                            <h3 className="text-xl font-bold text-white mb-4 text-center">Gestionar Perfiles</h3>
                            <p className="text-gray-400 text-center text-sm mb-6">Selecciona para cargar o elimina usuarios.</p>
                            
                            <div className="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-1">
                                {usersList.map(u => (
                                    <div key={u} className="flex items-center justify-between bg-slate-700 p-3 rounded-xl border border-slate-600 hover:border-blue-500 transition-colors">
                                        <button onClick={() => onLogin(u)} className="flex-1 text-left">
                                            <span className="text-white font-bold block">{u}</span>
                                            <span className="text-xs text-gray-400 uppercase font-bold">Cargar</span>
                                        </button>
                                        <button onClick={() => handleDelete(u)} className="p-3 text-gray-400 hover:text-red-500 hover:bg-slate-800 rounded-lg transition-colors" title="Borrar Usuario">
                                            <Trash2 size={20} />
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <div className="mt-6 pt-4 border-t border-slate-700 text-center">
                                <button onClick={() => setShowUserModal(false)} className="text-gray-500 hover:text-white text-sm font-bold uppercase">Cerrar</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>);
        };

        const Header = ({ goHome, onProfileClick, user, onLogout, resetData, ExtraContent, darkMode, toggleDarkMode }) => (
            <header className="bg-slate-900 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-40 border-b border-slate-800"><div className="flex items-center gap-3 cursor-pointer group" onClick={goHome}><div className="bg-gradient-to-br from-green-500 to-green-700 p-2 rounded-xl shadow-lg group-hover:scale-105 transition-transform duration-200"><Target className="text-white w-7 h-7" /></div><div className="hidden sm:block"><h1 className="text-2xl font-extrabold tracking-tight leading-none">TIRO MAESTRO</h1><p className="text-[10px] text-gray-400 uppercase tracking-widest">Examen Pool</p></div></div><div className="flex gap-3 items-center">{ExtraContent}<button onClick={toggleDarkMode} className="p-2 text-gray-400 hover:text-yellow-400 transition">{darkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>{user && <React.Fragment><button onClick={resetData} className="p-2 text-gray-400 hover:text-red-400"><Trash2 size={20}/></button><button onClick={onProfileClick} className="flex items-center gap-2 bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700"><div className="w-6 h-6 rounded-full bg-indigo-500 flex items-center justify-center text-[10px] font-bold">{user.charAt(0).toUpperCase()}</div><span className="font-medium hidden sm:inline text-sm">{user}</span></button><button onClick={onLogout} className="p-2 text-gray-400 hover:text-red-400"><LogOut size={20}/></button></React.Fragment>}</div></header>
        );

        const Glossary = ({ goBack }) => {
            const [search, setSearch] = useState("");
            return (
                <div className="max-w-3xl mx-auto p-4 animate-in-fade">
                    <button onClick={goBack} className="flex items-center text-gray-500 hover:text-gray-800 dark:hover:text-white mb-6 transition-colors">
                        <ChevronLeft size={20} /> Volver
                    </button>
                    <h2 className="text-3xl font-black mb-6 text-gray-900 dark:text-white flex items-center gap-3">
                        <BookOpen className="text-blue-600"/> Glosario
                    </h2>
                    <input 
                        type="text" 
                        placeholder="Buscar términos..." 
                        className="w-full p-4 border rounded-xl shadow-sm mb-6 bg-white dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" 
                        value={search} 
                        onChange={(e) => setSearch(e.target.value)} 
                    />
                    <div className="grid gap-4">
                        {glossaryTerms.filter(t => t.term.toLowerCase().includes(search.toLowerCase()) || t.def_es.toLowerCase().includes(search.toLowerCase())).map((t, i) => (
                            <div key={i} className="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow">
                                <h3 className="font-bold text-xl text-blue-600 dark:text-blue-400 mb-2">{t.term}</h3>
                                <p className="text-gray-600 dark:text-gray-300 text-sm leading-relaxed">{t.def_es}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        const ExamDetail = ({ exam, onBack, user, scores, updateScore, resetExamScore, notes, saveNote, initialActiveDrill }) => {
            const [activeDrill, setActiveDrill] = useState(initialActiveDrill || null);
            const [selectedVariationDrill, setSelectedVariationDrill] = useState(null);
            const [level, setLevel] = useState("Bachelors");
            const currentDrills = useMemo(() => (exam.id !== 'II' ? exam.drills : exam.drills), [exam, level]);
            
            // Si viene un drill inicial desde el historial, lo abrimos
            useEffect(() => {
                if (initialActiveDrill) {
                    setActiveDrill(initialActiveDrill);
                }
            }, [initialActiveDrill]);

            const handleDrillClick = (drill) => { if (drill.has_variations) setSelectedVariationDrill(drill); else setActiveDrill(drill); };
            const handleResetExam = () => { if(confirm("¿Estás seguro de reiniciar este examen?")) resetExamScore(exam.id); };
            const handleNextDrill = () => { if (!activeDrill) return; const currentIndex = currentDrills.findIndex(d => d.id === activeDrill.id); if (currentIndex >= 0 && currentIndex < currentDrills.length - 1) { const nextDrill = currentDrills[currentIndex + 1]; if (nextDrill.has_variations) { setActiveDrill(null); setSelectedVariationDrill(nextDrill); } else setActiveDrill(nextDrill); } else setActiveDrill(null); };
            const isLastDrill = activeDrill ? currentDrills.findIndex(d => d.id === activeDrill.id) === currentDrills.length - 1 : false;
            return (
                <div className="max-w-6xl mx-auto p-6 pb-24">
                    <>
                        <div className="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-4"><button onClick={onBack} className="p-2 bg-white border border-gray-200 rounded-lg text-gray-500 hover:bg-gray-50 shadow-sm"><ChevronLeft size={24} /></button><div><h2 className="text-3xl font-black text-gray-900">{exam.title}</h2><p className="text-gray-500">{exam.desc}</p></div></div><div className="flex items-center gap-3"><button onClick={handleResetExam} className="flex items-center gap-2 px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg font-bold text-sm transition border border-transparent hover:border-red-100"><RotateCcw size={16} /> Reiniciar Nivel</button>{exam.id === 'II' && <div className="flex bg-white p-1.5 rounded-xl border border-gray-200 shadow-sm">{['Bachelors', 'Masters', 'Doctorate'].map(l => <button key={l} onClick={() => setLevel(l)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${level === l ? 'bg-gray-900 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900'}`}>{l === 'Bachelors' ? 'Licenciatura' : l === 'Masters' ? 'Maestría' : 'Doctorado'}</button>)}</div>}</div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {currentDrills.map((drill) => {
                                const data = scores[exam.id] ? (scores[exam.id][drill.id] || {score: 0, attempts: 0}) : {score: 0, attempts: 0};
                                let currentScore = getSafeScore(data);
                                if (drill.isGroup) { currentScore = 0; drill.subDrills.forEach(sd => { const sdData = scores[exam.id] ? (scores[exam.id][sd.id] || {score: 0}) : {score: 0}; currentScore += getSafeScore(sdData); }); }
                                let maxDisplay = (typeof drill.max_score === 'object' ? drill.max_score[level] : drill.max_score) || 10;
                                if(drill.isGroup) maxDisplay = drill.subDrills.reduce((a,b) => a + b.max_score, 0);
                                return (
                                    <div key={drill.id} onClick={() => handleDrillClick(drill)} className="bg-white border border-gray-200 rounded-xl p-5 cursor-pointer hover:shadow-lg hover:border-green-400 transition-all group relative overflow-hidden"><div className="flex justify-between items-start mb-4 relative z-10"><div className="bg-gray-100 text-gray-600 font-bold w-12 h-12 rounded-lg flex items-center justify-center group-hover:bg-green-100 group-hover:text-green-700 text-lg">{drill.id.split('-')[0]}</div>{currentScore > 0 && <CheckCircle className="text-green-500" size={24} />}{(drill.isGroup || drill.has_variations) && <span className="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded">Multi</span>}</div><h3 className="font-bold text-lg text-gray-800 mb-1 group-hover:text-green-700 transition-colors relative z-10">{drill.name}</h3><p className="text-sm text-gray-500 mb-4 line-clamp-2 relative z-10">{drill.desc}</p><div className="w-full bg-gray-100 rounded-full h-1.5 mt-2 overflow-hidden"><div className="bg-green-500 h-1.5 rounded-full transition-all duration-500" style={{ width: `${(currentScore / maxDisplay) * 100}%` }}></div></div></div>
                                );
                            })}
                        </div>
                        {selectedVariationDrill && <VariationsModal drill={selectedVariationDrill} onClose={() => setSelectedVariationDrill(null)} onSelectVariation={(v) => { setSelectedVariationDrill(null); setActiveDrill(v); }} />}
                        {activeDrill && <PracticeModalFinal drill={activeDrill} fullData={scores[exam.id] || {}} onUpdateScore={(dId, s, a) => updateScore(exam.id, dId, s, a)} onClose={() => setActiveDrill(null)} onNextDrill={handleNextDrill} isLastDrill={isLastDrill} level={level} examId={exam.id} updateScore={updateScore} allScores={scores} notes={notes} saveNote={saveNote} />}
                    </>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null); 
            const [view, setView] = useState('login'); 
            const [selectedExam, setSelectedExam] = useState(null);
            const [activeDrillFromHistory, setActiveDrillFromHistory] = useState(null);
            const [allScores, setAllScores] = useState({});
            const [notes, setNotes] = useState({});
            const [history, setHistory] = useState([]);
            const [darkMode, setDarkMode] = useState(localStorage.getItem('bu_dark_mode') === 'true');

            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                localStorage.setItem('bu_dark_mode', darkMode);
            }, [darkMode]);

            const loadUserData = (u) => {
                const savedScores = localStorage.getItem(`bu_scores_${u}`);
                const savedNotes = localStorage.getItem(`bu_notes_${u}`);
                const savedHistory = localStorage.getItem(`bu_history_${u}`);
                
                setAllScores(savedScores ? JSON.parse(savedScores) : {});
                setNotes(savedNotes ? JSON.parse(savedNotes) : {});
                setHistory(savedHistory ? JSON.parse(savedHistory) : []);
            };

            const handleLogin = (u) => { 
                localStorage.setItem('bu_current_user', u); 
                setUser(u); 
                loadUserData(u);
                setView('home'); 
            };

            const handleLogout = () => { 
                localStorage.removeItem('bu_current_user'); 
                setUser(null); 
                setAllScores({}); 
                setNotes({}); 
                setView('login'); 
            };

            const updateScore = (eId, dId, val, att) => { 
                const newScores = { ...allScores, [eId]: { ...(allScores[eId] || {}), [dId]: {score: val, attempts: att} } }; 
                setAllScores(newScores); 
                localStorage.setItem(`bu_scores_${user}`, JSON.stringify(newScores)); 
            };
            const saveNote = (eId, dId, text) => { const newNotes = { ...notes, [`${eId}-${dId}`]: text }; setNotes(newNotes); localStorage.setItem(`bu_notes_${user}`, JSON.stringify(newNotes)); };
            const handleExport = () => { const data = { user, scores: allScores, notes, history, date: new Date().toISOString() }; const blob = new Blob([JSON.stringify(data)], { type: "application/json" }); const href = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = href; link.download = `bu_data_${user}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const handleImport = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (confirm(`Importar datos de ${data.user}?`)) { setAllScores(data.scores || {}); setNotes(data.notes || {}); setHistory(data.history || []); localStorage.setItem(`bu_scores_${user}`, JSON.stringify(data.scores || {})); localStorage.setItem(`bu_notes_${user}`, JSON.stringify(data.notes || {})); localStorage.setItem(`bu_history_${user}`, JSON.stringify(data.history || [])); alert("Datos importados."); } } catch (err) { alert("Error."); } }; reader.readAsText(file); };
            const resetExamScore = (eId) => { const ns = { ...allScores }; delete ns[eId]; setAllScores(ns); localStorage.setItem(`bu_scores_${user}`, JSON.stringify(ns)); };
            const resetAllData = () => { if(confirm("¿Borrar todo?")) { setAllScores({}); setNotes({}); localStorage.removeItem(`bu_scores_${user}`); localStorage.removeItem(`bu_notes_${user}`); localStorage.removeItem(`bu_history_${user}`); } };

            const handleDrillSelectFromHistory = (exam, drill) => {
                setSelectedExam(exam);
                setActiveDrillFromHistory(drill);
                setView('exam');
            };
            
            if (view === 'login' || !user) return <LoginScreen onLogin={handleLogin} />;

            return (
                <div className="min-h-screen flex flex-col bg-slate-900 font-sans text-gray-100 transition-colors duration-300">
                    <Header goHome={() => {setSelectedExam(null); setView('home');}} onProfileClick={() => setView('profile')} user={user} onLogout={handleLogout} resetData={resetAllData} ExtraContent={<SessionTimer />} darkMode={darkMode} toggleDarkMode={() => setDarkMode(!darkMode)} />
                    <main className="flex-grow">{view === 'home' && <div className="max-w-5xl mx-auto p-6"><div className="text-center mb-12 mt-8"><h1 className="text-5xl font-black text-white mb-4 tracking-tight">TIRO MAESTRO</h1><p className="text-xl text-gray-400 max-w-2xl mx-auto font-light">Plan de Evaluación Profesional</p></div><div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-16">{Object.values(examsData).map(exam => <ExamCard key={exam.id} exam={exam} onSelect={(e) => { setSelectedExam(e); setView('exam'); }} />)}</div><div className="flex justify-center"><button onClick={() => setView('glossary')} className="flex items-center gap-3 text-gray-300 hover:text-blue-400 font-bold transition px-8 py-4 bg-slate-800 rounded-2xl shadow-sm border border-slate-700 hover:shadow-md"><BookOpen size={24} className="text-blue-500" /> Glosario</button></div></div>}{view === 'profile' && <UserProfile user={user} scores={allScores} goBack={() => setView('home')} onExport={handleExport} onImport={handleImport} history={history} onDrillSelect={handleDrillSelectFromHistory} />}{view === 'exam' && selectedExam && <ExamDetail exam={selectedExam} onBack={() => { setSelectedExam(null); setView('home'); setActiveDrillFromHistory(null); }} user={user} scores={allScores} updateScore={updateScore} resetExamScore={resetExamScore} notes={notes} saveNote={saveNote} initialActiveDrill={activeDrillFromHistory} />}{view === 'glossary' && <Glossary goBack={() => setView('home')} />}</main>
                    <footer className="bg-slate-900 border-t border-slate-800 p-8 text-center"><div className="max-w-2xl mx-auto"><div className="flex justify-center items-center gap-2 mb-4 text-gray-500"><GraduationCap size={24} /></div><p className="text-sm text-gray-400 mb-2 font-medium">&copy; 2025 Tiro Maestro App</p><p className="text-xs text-gray-500 leading-relaxed">Basado en el currículo del <strong className="text-gray-600 dark:text-gray-300">Dr. Dave Alciatore</strong>.<br/>Desarrollado por <strong className="text-gray-600 dark:text-gray-300">Juan Miguel Rios Redondo</strong>.</p><a href="https://juanmiguel0927.github.io/Pool/" target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 text-blue-400 hover:text-blue-300 font-bold mt-3 text-sm hover:underline">Tiro Maestro (Entrenamiento)</a></div></footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
